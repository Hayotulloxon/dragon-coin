<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dragon Coin - Tap to Earn</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
        import { getDatabase, ref, set, get, onValue, push, update } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDShZAo9lg-SxpQViCT27uXVni1UK7TGYU",
            authDomain: "dragon-92897.firebaseapp.com",
            databaseURL: "https://dragon-92897-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "dragon-92897",
            storageBucket: "dragon-92897.firebasestorage.app",
            messagingSenderId: "40351345340",
            appId: "1:40351345340:web:632388a9b45d3c7905feb9",
            measurementId: "G-FXT1F3NPCD"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);

        // Make Firebase available globally
        window.firebaseApp = app;
        window.firebaseDatabase = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebaseOnValue = onValue;
        window.firebasePush = push;
        window.firebaseUpdate = update;
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%),
                linear-gradient(135deg, #0a0a0f 0%, #1a0a1a 25%, #0f0a1a 50%, #1a1a0f 75%, #0a0f1a 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 98px,
                    rgba(0, 255, 136, 0.03) 100px
                ),
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 98px,
                    rgba(255, 107, 53, 0.03) 100px
                );
            pointer-events: none;
            z-index: -1;
        }

        .header {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid rgba(0, 255, 136, 0.3);
            box-shadow: 
                0 0 20px rgba(0, 255, 136, 0.2),
                inset 0 0 20px rgba(255, 255, 255, 0.05);
        }

        .firebase-status {
            position: fixed;
            top: 70px;
            left: 20px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 100;
            transition: all 0.5s ease;
            opacity: 1;
        }

        .firebase-connected {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            border: 1px solid #00ff88;
        }

        .firebase-disconnected {
            background: rgba(255, 107, 53, 0.2);
            color: #ff6b35;
            border: 1px solid #ff6b35;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .level-badge {
            background: #00ff88;
            color: #000;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .energy-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .energy-fill {
            width: 100px;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
        }

        .energy-progress {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00cc6a);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .main-container {
            padding: 20px;
            text-align: center;
        }

        .navigation-tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .nav-tab {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            padding: 10px 16px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(0, 255, 136, 0.5);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .nav-tab.active {
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            color: #000000;
            border-color: #00ff88;
            box-shadow: 
                0 0 30px rgba(0, 255, 136, 0.6),
                inset 0 0 20px rgba(255, 255, 255, 0.2);
        }

        .balance-display {
            margin-bottom: 30px;
        }

        .balance-amount {
            font-size: 48px;
            font-weight: bold;
            color: #00ff88;
            margin-bottom: 5px;
            text-shadow: 
                0 0 10px #00ff88,
                0 0 20px #00ff88,
                0 0 30px #00ff88,
                0 0 40px #00ff88;
            animation: balanceGlow 3s ease-in-out infinite alternate;
        }

        @keyframes balanceGlow {
            0% {
                text-shadow: 
                    0 0 10px #00ff88,
                    0 0 20px #00ff88,
                    0 0 30px #00ff88,
                    0 0 40px #00ff88;
            }
            100% {
                text-shadow: 
                    0 0 15px #00ff88,
                    0 0 30px #00ff88,
                    0 0 45px #00ff88,
                    0 0 60px #00ff88;
            }
        }

        .balance-label {
            color: #cccccc;
            font-size: 16px;
        }

        .coin-container {
            position: relative;
            margin: 40px auto;
            width: 280px;
            height: 280px;
            perspective: 1000px;
        }

        .main-coin {
            width: 280px;
            height: 280px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 25%, #FFD700 50%, #FFED4E 75%, #FFD700 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 120px;
            cursor: pointer;
            transition: all 0.1s ease;
            position: relative;
            overflow: hidden;
            border: 8px solid #FFA500;
            box-shadow: 
                0 20px 40px rgba(255, 165, 0, 0.4),
                0 10px 20px rgba(0, 0, 0, 0.2),
                inset 0 4px 8px rgba(255, 255, 255, 0.3),
                inset 0 -4px 8px rgba(255, 140, 0, 0.3);
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .main-coin::before {
            content: '';
            position: absolute;
            top: 15%;
            left: 15%;
            width: 30%;
            height: 30%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.6) 0%, transparent 70%);
            border-radius: 50%;
            z-index: 1;
        }

        .main-coin:hover {
            transform: scale(1.02);
        }

        .main-coin:active {
            transform: scale(0.98) !important;
        }
        
        .main-coin.tap-animation {
            transform: scale(0.95);
            transition: transform 0.05s ease;
        }

        .tap-effect {
            position: absolute;
            color: #00ff88;
            font-size: 28px;
            font-weight: bold;
            pointer-events: none;
            text-shadow: 
                0 0 15px #00ff88,
                0 0 30px #00ff88,
                0 0 45px #00ff88,
                0 0 60px #00ff88;
            animation: neonFloatUp 1s ease-out forwards;
            z-index: 10;
            user-select: none;
            -webkit-user-select: none;
        }

        @keyframes neonFloatUp {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-80px) scale(0.8);
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(0, 255, 136, 0.3);
            box-shadow: 
                0 0 20px rgba(0, 255, 136, 0.2),
                inset 0 0 20px rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: rgba(0, 255, 136, 0.6);
            box-shadow: 
                0 0 30px rgba(0, 255, 136, 0.4),
                inset 0 0 30px rgba(255, 255, 255, 0.1);
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #00ff88;
        }

        .stat-label {
            font-size: 12px;
            color: #cccccc;
            margin-top: 5px;
        }

        .conditions-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }

        .condition-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .condition-item:last-child {
            border-bottom: none;
        }

        .task-button {
            cursor: pointer;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .task-button:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(0, 255, 136, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.2);
        }

        .task-button.completed {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
            cursor: default;
        }

        .task-button.completed:hover {
            transform: none;
            box-shadow: none;
        }

        .task-button.task-ready {
            background: rgba(0, 255, 136, 0.1);
            border-color: #00ff88;
            animation: taskPulse 2s ease-in-out infinite;
        }

        @keyframes taskPulse {
            0% { box-shadow: 0 0 10px rgba(0, 255, 136, 0.3); }
            50% { box-shadow: 0 0 20px rgba(0, 255, 136, 0.6); }
            100% { box-shadow: 0 0 10px rgba(0, 255, 136, 0.3); }
        }

        .condition-text {
            flex: 1;
        }

        .condition-reward {
            color: #00ff88;
            font-weight: bold;
        }

        .condition-status {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-left: 10px;
        }

        .condition-completed {
            background: #00ff88;
        }

        .condition-pending {
            background: rgba(255, 255, 255, 0.3);
        }

        .completed-tasks-section {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .completed-task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(0, 255, 136, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .completed-task-item:last-child {
            margin-bottom: 0;
        }

        .completed-task-text {
            flex: 1;
            color: #00ff88;
        }

        .completed-task-reward {
            color: #00ff88;
            font-weight: bold;
            background: rgba(0, 255, 136, 0.2);
            padding: 4px 8px;
            border-radius: 6px;
        }

        .completed-task-check {
            color: #00ff88;
            font-size: 18px;
            margin-left: 10px;
        }

        .section {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid #00ff88;
            color: #00ff88;
        }

        .notification.error {
            background: rgba(255, 107, 53, 0.2);
            border: 1px solid #ff6b35;
            color: #ff6b35;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .language-selector {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .language-selector:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .country-flag {
            font-size: 20px;
            margin-right: 8px;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 8px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b35, #f7931e);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .header {
                padding: 10px 15px;
                flex-wrap: wrap;
                gap: 10px;
            }

            .main-container {
                padding: 15px;
            }

            .main-coin {
                width: 220px;
                height: 220px;
                font-size: 90px;
            }
            
            .coin-container {
                width: 220px;
                height: 220px;
                margin: 30px auto;
            }
            
            .balance-amount {
                font-size: 32px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin: 20px 0;
            }

            .navigation-tabs {
                gap: 4px;
                margin-bottom: 15px;
            }

            .nav-tab {
                padding: 8px 10px;
                font-size: 11px;
                flex: 1;
                min-width: 0;
            }
        }
    </style>
</head>
<body>

    <!-- Firebase Status Indicator -->
    <div class="firebase-status firebase-disconnected" id="firebaseStatus">
        üîÑ Firebase ulanmoqda...
    </div>

    <!-- Language Selector -->
    <div class="language-selector" onclick="toggleLanguage()">
        <span class="country-flag" id="countryFlag">üá∫üáø</span>
        <span id="languageText">UZ</span>
    </div>

    <div class="header">
        <div class="user-info">
            <div class="avatar">üêâ</div>
            <div>
                <div style="font-weight: bold;" id="playerName">Dragon Miner</div>
                <div class="level-badge" id="levelBadge">Level 1</div>
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <div class="energy-bar">
                <span>‚ö°</span>
                <div class="energy-fill">
                    <div class="energy-progress" id="energyProgress"></div>
                </div>
                <span id="energyText">1000/1000</span>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="navigation-tabs">
            <button class="nav-tab active" id="tapTab" onclick="showSection('tap')">üêâ <span data-translate="tap">Tapping</span></button>
            <button class="nav-tab" id="tasksTab" onclick="showSection('tasks')">üìã <span data-translate="tasks">Vazifalar</span></button>
            <button class="nav-tab" id="referralTab" onclick="showSection('referral')">üë• <span data-translate="referral">Referral</span></button>
            <button class="nav-tab" id="leaderboardTab" onclick="showSection('leaderboard')">üèÜ <span data-translate="leaderboard">Reyting</span></button>
            <button class="nav-tab" id="adminTab" onclick="showSection('admin')" style="display: none;">‚öôÔ∏è <span data-translate="admin">Admin</span></button>
        </div>

        <div class="balance-display">
            <div class="balance-amount" id="balance">0</div>
            <div class="balance-label">Dragon Coins</div>
        </div>

        <div class="section" id="tapSection">
            <div class="coin-container">
                <div class="main-coin" id="mainCoin" onclick="tapCoin(event)">
                    <span style="
                        font-size: 120px; 
                        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
                        z-index: 2;
                        position: relative;
                    ">üêâ</span>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="tapPower">1</div>
                    <div class="stat-label" data-translate="coinsPerTap">Coins per tap</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalTaps">0</div>
                    <div class="stat-label" data-translate="totalTaps">Total taps</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="level">1</div>
                    <div class="stat-label" data-translate="level">Level</div>
                    <div class="stat-label" id="levelName" style="color: #00ff88; font-size: 10px; margin-top: 2px;">Wood</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="referralCount">0</div>
                    <div class="stat-label" data-translate="referrals">Referrals</div>
                </div>
            </div>

            <!-- Level Progress Bar -->
            <div style="background: rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 20px; margin: 20px 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div style="font-size: 16px; font-weight: bold;" id="currentLevelDisplay">Level 1 - Wood</div>
                    <div style="font-size: 14px; color: #ccc;" id="nextLevelDisplay">Next: Level 2 - Bronze</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="levelProgressBar" style="width: 0%;"></div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: #ccc; margin-top: 5px;">
                    <span id="currentTapsDisplay">0 taps</span>
                    <span id="requiredTapsDisplay">500 taps kerak</span>
                </div>
            </div>

            <div id="energyWarning" class="notification error" style="display: none; position: relative; top: auto; right: auto; margin: 20px 0;">
                <span data-translate="energyWarning">‚ö†Ô∏è Energy bo'sh! Energiya to'lishi uchun kutib turing.</span>
            </div>
        </div>

        <div class="section" id="tasksSection" style="display: none;">
            <!-- Completed Tasks Section -->
            <div class="completed-tasks-section" id="completedTasksSection" style="display: none;">
                <h3 style="margin-bottom: 15px; color: #00ff88; display: flex; align-items: center; gap: 10px;">
                    ‚úÖ <span data-translate="completedTasks">Bajarilgan Vazifalar</span>
                    <span style="background: rgba(0, 255, 136, 0.2); color: #00ff88; padding: 4px 8px; border-radius: 12px; font-size: 12px;" id="completedTasksCount">0</span>
                </h3>
                <div id="completedTasksList">
                    <!-- Completed tasks will be populated here -->
                </div>
            </div>

            <div class="conditions-panel" id="conditionsPanel">
                <h3 style="margin-bottom: 15px; color: #ff6b35;">üìã <span data-translate="tasks">Vazifalar</span></h3>
                <div class="condition-item task-button" onclick="claimTask('taps')" id="tapTask">
                    <div class="condition-text">
                        <div data-translate="task500taps">500 marta tap qiling</div>
                        <div style="font-size: 12px; color: #ccc;"><span data-translate="progress">Progress</span>: <span id="tapProgress">0</span>/500</div>
                    </div>
                    <div class="condition-reward">+1000 DRC</div>
                    <div class="condition-status condition-pending" id="tapCondition"></div>
                </div>
                <div class="condition-item task-button" onclick="claimTask('level')" id="levelTask">
                    <div class="condition-text">
                        <div data-translate="taskLevel5">Level 5 ga yeting</div>
                        <div style="font-size: 12px; color: #ccc;"><span data-translate="currentLevel">Hozirgi level</span>: <span id="currentLevel">1</span></div>
                    </div>
                    <div class="condition-reward">+2000 DRC</div>
                    <div class="condition-status condition-pending" id="levelCondition"></div>
                </div>
                <div class="condition-item task-button" onclick="claimTask('coins')" id="coinTask">
                    <div class="condition-text">
                        <div data-translate="task10000coins">10000 coin to'plang</div>
                        <div style="font-size: 12px; color: #ccc;"><span data-translate="progress">Progress</span>: <span id="coinProgress">0</span>/10000</div>
                    </div>
                    <div class="condition-reward">+5000 DRC</div>
                    <div class="condition-status condition-pending" id="coinCondition"></div>
                </div>
                <div class="condition-item task-button" onclick="claimTask('referral')" id="referralTask">
                    <div class="condition-text">
                        <div data-translate="taskReferral">5 ta do'st taklif qiling</div>
                        <div style="font-size: 12px; color: #ccc;"><span data-translate="progress">Progress</span>: <span id="referralProgress">0</span>/5</div>
                    </div>
                    <div class="condition-reward">+3000 DRC</div>
                    <div class="condition-status condition-pending" id="referralCondition"></div>
                </div>
                <div class="condition-item task-button" onclick="claimTask('telegram')" id="telegramTask">
                    <div class="condition-text">
                        <div data-translate="taskTelegram">Telegram kanalga obuna bo'ling</div>
                        <div style="font-size: 12px; color: #ccc;">@DragonCoinChannel</div>
                    </div>
                    <div class="condition-reward">+1500 DRC</div>
                    <div class="condition-status condition-pending" id="telegramCondition"></div>
                </div>
                <div class="condition-item task-button" onclick="claimTask('youtube')" id="youtubeTask">
                    <div class="condition-text">
                        <div data-translate="taskYoutube">YouTube kanalga obuna bo'ling</div>
                        <div style="font-size: 12px; color: #ccc;">Dragon Coin Official</div>
                    </div>
                    <div class="condition-reward">+2000 DRC</div>
                    <div class="condition-status condition-pending" id="youtubeCondition"></div>
                </div>
                <div class="condition-item task-button" onclick="claimTask('code')" id="codeTask">
                    <div class="condition-text">
                        <div data-translate="taskCode">Maxsus kodni kiriting</div>
                        <div style="font-size: 12px; color: #ccc;">Videoda ko'rsatilgan kod</div>
                    </div>
                    <div class="condition-reward">+5000 DRC</div>
                    <div class="condition-status condition-pending" id="codeCondition"></div>
                </div>
                
                <!-- Admin Tasks Section -->
                <div id="adminTasksSection" style="display: none;">
                    <h4 style="margin: 20px 0 10px 0; color: #ff6b35;">üéØ Admin Vazifalari</h4>
                    <div id="adminTasksList">
                        <!-- Admin tasks will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Referral Section -->
        <div class="section" id="referralSection" style="display: none;">
            <div class="conditions-panel">
                <h3 style="margin-bottom: 15px; color: #ff6b35;">üë• <span data-translate="referralSystem">Referral Tizimi</span></h3>
                
                <div style="margin-bottom: 20px;">
                    <h4 data-translate="yourReferralLink">Sizning referral linkingiz:</h4>
                    <div style="background: rgba(0, 255, 136, 0.1); border: 2px solid #00ff88; border-radius: 10px; padding: 15px; margin: 15px 0; word-break: break-all; font-family: monospace; font-size: 14px;" id="referralLink">
                        https://t.me/Dragon_coin_money_bot?start=ref_<span id="userReferralCode">123456</span>
                    </div>
                    <button style="background: #00ff88; color: #000; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; margin: 10px 0; transition: all 0.3s ease;" onclick="copyReferralLink()">
                        üìã <span data-translate="copyLink">Linkni nusxalash</span>
                    </button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalReferrals">0</div>
                        <div class="stat-label" data-translate="totalReferrals">Jami referrallar</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="referralEarnings">0</div>
                        <div class="stat-label" data-translate="referralEarnings">Referral daromadi</div>
                    </div>
                </div>

                <div style="background: rgba(0, 255, 136, 0.1); border-radius: 10px; padding: 15px; margin: 20px 0;">
                    <h4 data-translate="referralRewards">Referral mukofotlari:</h4>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li data-translate="reward1">Har bir referral uchun: +500 DRC</li>
                        <li data-translate="reward2">Referral birinchi marta tap qilganda: +200 DRC</li>
                        <li data-translate="reward3">Referral Level 5 ga yetganda: +1000 DRC</li>
                        <li data-translate="reward4">Referral 10000 coin to'plaganda: +2000 DRC</li>
                    </ul>
                </div>

                <h4 data-translate="yourReferrals">Sizning referrallaringiz:</h4>
                <div id="referralList">
                    <div style="text-align: center; color: #ccc; padding: 20px;" data-translate="noReferrals">
                        Hali referrallaringiz yo'q. Do'stlaringizni taklif qiling!
                    </div>
                </div>
            </div>
        </div>

        <!-- Leaderboard Section -->
        <div class="section" id="leaderboardSection" style="display: none;">
            <div class="conditions-panel">
                <h3 style="margin-bottom: 15px; color: #ff6b35;">üèÜ <span data-translate="leaderboard">Reyting Jadvali</span></h3>
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px; justify-content: center;">
                    <button class="nav-tab active" id="coinsLeaderboard" onclick="showLeaderboard('coins')" style="padding: 8px 16px;">
                        üí∞ <span data-translate="byCoins">Coinlar bo'yicha</span>
                    </button>
                    <button class="nav-tab" id="referralsLeaderboard" onclick="showLeaderboard('referrals')" style="padding: 8px 16px;">
                        üë• <span data-translate="byReferrals">Referrallar bo'yicha</span>
                    </button>
                </div>

                <div style="background: rgba(0, 255, 136, 0.1); border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 18px; font-weight: bold; color: #00ff88;" data-translate="yourRank">Sizning o'rningiz:</div>
                    <div style="font-size: 24px; font-weight: bold; margin-top: 5px;" id="playerRank">#-</div>
                </div>

                <div id="leaderboardList">
                    <!-- Leaderboard items will be populated here -->
                </div>
            </div>
        </div>

        <!-- Admin Panel Section -->
        <div class="section" id="adminSection" style="display: none;">
            <div class="conditions-panel">
                <h3 style="margin-bottom: 15px; color: #ff6b35;">‚öôÔ∏è <span data-translate="adminPanel">Admin Panel</span></h3>
                
                <!-- Add New Task Form -->
                <div style="background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #00ff88;">‚ûï Yangi Vazifa Qo'shish</h4>
                    
                    <div style="display: grid; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #ccc;">Vazifa nomi:</label>
                            <input type="text" id="taskTitle" placeholder="Masalan: Instagram sahifaga obuna bo'ling" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #ccc;">Tavsif:</label>
                            <input type="text" id="taskDescription" placeholder="@dragoncoin_official" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #ccc;">Mukofot (DRC):</label>
                                <input type="number" id="taskReward" placeholder="1000" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #ccc;">Turi:</label>
                                <select id="taskType" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                                    <option value="link">Link ochish</option>
                                    <option value="code">Kod kiritish</option>
                                    <option value="subscribe">Obuna bo'lish</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #ccc;">Link (ixtiyoriy):</label>
                            <input type="url" id="taskLink" placeholder="https://t.me/dragoncoin_official" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #ccc;">To'g'ri kod (kod turi uchun):</label>
                            <input type="text" id="taskCode" placeholder="DRAGON2024" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                        </div>
                        
                        <button onclick="addAdminTask()" style="background: #00ff88; color: #000; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">
                            ‚ûï Vazifa Qo'shish
                        </button>
                    </div>
                </div>
                
                <!-- Existing Admin Tasks -->
                <div style="background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 20px;">
                    <h4 style="margin-bottom: 15px; color: #00ff88;">üìã Mavjud Admin Vazifalari</h4>
                    <div id="adminTasksDisplay">
                        <div style="text-align: center; color: #ccc; padding: 20px;">
                            Hali admin vazifalari qo'shilmagan
                        </div>
                    </div>
                </div>
                
                <!-- Admin Controls -->
                <div style="background: rgba(255, 107, 53, 0.1); border-radius: 15px; padding: 20px; margin-top: 20px;">
                    <h4 style="margin-bottom: 15px; color: #ff6b35;">üîß Admin Boshqaruv</h4>
                    <div style="display: grid; gap: 10px;">
                        <button onclick="clearAllTasks()" style="background: rgba(255, 107, 53, 0.2); color: #ff6b35; border: 1px solid #ff6b35; padding: 10px 15px; border-radius: 8px; cursor: pointer;">
                            üóëÔ∏è Barcha vazifalarni tozalash
                        </button>
                        <button onclick="exportGameData()" style="background: rgba(0, 255, 136, 0.2); color: #00ff88; border: 1px solid #00ff88; padding: 10px 15px; border-radius: 8px; cursor: pointer;">
                            üì§ O'yin ma'lumotlarini eksport qilish
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Multi-language support
        const translations = {
            uz: {
                tap: "Tapping",
                tasks: "Vazifalar",
                referral: "Referral",
                leaderboard: "Reyting",
                admin: "Admin",
                adminPanel: "Admin Panel",
                coinsPerTap: "Har tap uchun coin",
                totalTaps: "Jami taplar",
                level: "Level",
                referrals: "Referrallar",
                energyWarning: "‚ö†Ô∏è Energy bo'sh! Energiya to'lishi uchun kutib turing.",
                task500taps: "500 marta tap qiling",
                taskLevel5: "Level 5 ga yeting",
                task10000coins: "10000 coin to'plang",
                taskReferral: "5 ta do'st taklif qiling",
                taskTelegram: "Telegram kanalga obuna bo'ling",
                taskYoutube: "YouTube kanalga obuna bo'ling",
                taskCode: "Maxsus kodni kiriting",
                progress: "Progress",
                currentLevel: "Hozirgi level",
                referralSystem: "Referral Tizimi",
                yourReferralLink: "Sizning referral linkingiz:",
                copyLink: "Linkni nusxalash",
                totalReferrals: "Jami referrallar",
                referralEarnings: "Referral daromadi",
                referralRewards: "Referral mukofotlari:",
                reward1: "Har bir referral uchun: +500 DRC",
                reward2: "Referral birinchi marta tap qilganda: +200 DRC",
                reward3: "Referral Level 5 ga yetganda: +1000 DRC",
                reward4: "Referral 10000 coin to'plaganda: +2000 DRC",
                yourReferrals: "Sizning referrallaringiz:",
                noReferrals: "Hali referrallaringiz yo'q. Do'stlaringizni taklif qiling!",
                byCoins: "Coinlar bo'yicha",
                byReferrals: "Referrallar bo'yicha",
                yourRank: "Sizning o'rningiz:",
                completedTasks: "Bajarilgan Vazifalar"
            },
            en: {
                tap: "Tapping",
                tasks: "Tasks",
                referral: "Referral",
                leaderboard: "Leaderboard",
                coinsPerTap: "Coins per tap",
                totalTaps: "Total taps",
                level: "Level",
                referrals: "Referrals",
                energyWarning: "‚ö†Ô∏è Energy empty! Wait for energy to refill.",
                task500taps: "Tap 500 times",
                taskLevel5: "Reach Level 5",
                task10000coins: "Collect 10000 coins",
                taskReferral: "Invite 5 friends",
                progress: "Progress",
                currentLevel: "Current level",
                referralSystem: "Referral System",
                yourReferralLink: "Your referral link:",
                copyLink: "Copy Link",
                totalReferrals: "Total Referrals",
                referralEarnings: "Referral Earnings",
                referralRewards: "Referral Rewards:",
                reward1: "For each referral: +500 DRC",
                reward2: "When referral first taps: +200 DRC",
                reward3: "When referral reaches Level 5: +1000 DRC",
                reward4: "When referral collects 10000 coins: +2000 DRC",
                yourReferrals: "Your Referrals:",
                noReferrals: "No referrals yet. Invite your friends!",
                byCoins: "By Coins",
                byReferrals: "By Referrals",
                yourRank: "Your Rank:",
                completedTasks: "Completed Tasks"
            },
            ru: {
                tap: "–¢–∞–ø–∏–Ω–≥",
                tasks: "–ó–∞–¥–∞–Ω–∏—è",
                referral: "–†–µ—Ñ–µ—Ä–∞–ª",
                leaderboard: "–†–µ–π—Ç–∏–Ω–≥",
                coinsPerTap: "–ú–æ–Ω–µ—Ç –∑–∞ —Ç–∞–ø",
                totalTaps: "–í—Å–µ–≥–æ —Ç–∞–ø–æ–≤",
                level: "–£—Ä–æ–≤–µ–Ω—å",
                referrals: "–†–µ—Ñ–µ—Ä–∞–ª—ã",
                energyWarning: "‚ö†Ô∏è –≠–Ω–µ—Ä–≥–∏—è –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å! –ü–æ–¥–æ–∂–¥–∏—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.",
                task500taps: "–¢–∞–ø–Ω–∏—Ç–µ 500 —Ä–∞–∑",
                taskLevel5: "–î–æ—Å—Ç–∏–≥–Ω–∏—Ç–µ 5 —É—Ä–æ–≤–Ω—è",
                task10000coins: "–°–æ–±–µ—Ä–∏—Ç–µ 10000 –º–æ–Ω–µ—Ç",
                taskReferral: "–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ 5 –¥—Ä—É–∑–µ–π",
                progress: "–ü—Ä–æ–≥—Ä–µ—Å—Å",
                currentLevel: "–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å",
                referralSystem: "–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –°–∏—Å—Ç–µ–º–∞",
                yourReferralLink: "–í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:",
                copyLink: "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É",
                totalReferrals: "–í—Å–µ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤",
                referralEarnings: "–î–æ—Ö–æ–¥ —Å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤",
                referralRewards: "–ù–∞–≥—Ä–∞–¥—ã –∑–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤:",
                reward1: "–ó–∞ –∫–∞–∂–¥–æ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–∞: +500 DRC",
                reward2: "–ö–æ–≥–¥–∞ —Ä–µ—Ñ–µ—Ä–∞–ª –ø–µ—Ä–≤—ã–π —Ä–∞–∑ —Ç–∞–ø–Ω–µ—Ç: +200 DRC",
                reward3: "–ö–æ–≥–¥–∞ —Ä–µ—Ñ–µ—Ä–∞–ª –¥–æ—Å—Ç–∏–≥–Ω–µ—Ç 5 —É—Ä–æ–≤–Ω—è: +1000 DRC",
                reward4: "–ö–æ–≥–¥–∞ —Ä–µ—Ñ–µ—Ä–∞–ª —Å–æ–±–µ—Ä–µ—Ç 10000 –º–æ–Ω–µ—Ç: +2000 DRC",
                yourReferrals: "–í–∞—à–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—ã:",
                noReferrals: "–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤. –ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –¥—Ä—É–∑–µ–π!",
                byCoins: "–ü–æ –º–æ–Ω–µ—Ç–∞–º",
                byReferrals: "–ü–æ —Ä–µ—Ñ–µ—Ä–∞–ª–∞–º",
                yourRank: "–í–∞—à–µ –º–µ—Å—Ç–æ:",
                completedTasks: "–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ó–∞–¥–∞–Ω–∏—è"
            }
        };

        let currentLanguage = 'uz';
        const countryFlags = {
            uz: 'üá∫üáø',
            en: 'üá∫üá∏',
            ru: 'üá∑üá∫'
        };

        // Level system with names and requirements
        const levelSystem = {
            1: { name: 'Wood', tapsRequired: 0, color: '#8B4513' },
            2: { name: 'Bronze', tapsRequired: 500, color: '#CD7F32' },
            3: { name: 'Silver', tapsRequired: 1500, color: '#C0C0C0' },
            4: { name: 'Gold', tapsRequired: 3500, color: '#FFD700' },
            5: { name: 'Platinum', tapsRequired: 7000, color: '#E5E4E2' },
            6: { name: 'Diamond', tapsRequired: 12000, color: '#B9F2FF' },
            7: { name: 'Master', tapsRequired: 20000, color: '#FF6B35' },
            8: { name: 'Grandmaster', tapsRequired: 35000, color: '#9932CC' },
            9: { name: 'Legend', tapsRequired: 60000, color: '#FF1493' },
            10: { name: 'Mythic', tapsRequired: 100000, color: '#00FFFF' }
        };

        // Game state
        let gameState = {
            balance: 0,
            energy: 1000,
            maxEnergy: 1000,
            tapPower: 1,
            totalTaps: 0,
            level: 1,
            completedTasks: {
                taps: false,
                level: false,
                coins: false,
                referral: false,
                telegram: false,
                youtube: false,
                code: false
            },
            lastSaveTime: Date.now(),
            referralCode: generateReferralCode(),
            referrals: [],
            referralEarnings: 0,
            referredBy: null,
            playerName: 'Dragon Miner',
            country: 'UZ',
            isAdmin: false,
            adminTasks: []
        };

        let globalPlayers = [];
        let firebaseConnected = false;
        let tapEffectPool = [];
        let lastUIUpdate = 0;
        let pendingUIUpdate = false;
        let lastTapTime = 0;

        // Generate unique referral code
        function generateReferralCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // Firebase connection
        function initializeFirebaseConnection() {
            console.log('üîÑ Firebase ulanishni tekshirish...');
            updateFirebaseStatus(false);
            
            setTimeout(() => {
                try {
                    if (window.firebaseDatabase) {
                        console.log('‚úÖ Firebase muvaffaqiyatli ulandi');
                        firebaseConnected = true;
                        updateFirebaseStatus(true);
                        loadPlayersFromFirebase();
                        savePlayerToFirebase();
                    } else {
                        throw new Error('Firebase not available');
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è Firebase mavjud emas, mahalliy rejimda ishlash');
                    firebaseConnected = false;
                    updateFirebaseStatus(false);
                    generateDemoPlayers();
                }
            }, 2000);
        }

        function updateFirebaseStatus(connected) {
            const statusElement = document.getElementById('firebaseStatus');
            if (connected) {
                statusElement.textContent = 'üî• Firebase Ulandi - Real-time sinxronizatsiya';
                statusElement.className = 'firebase-status firebase-connected';
                
                setTimeout(() => {
                    statusElement.style.opacity = '0';
                    setTimeout(() => {
                        statusElement.style.display = 'none';
                    }, 500);
                }, 3000);
            } else {
                statusElement.textContent = 'üì± Mahalliy rejim - Firebase mavjud emas';
                statusElement.className = 'firebase-status firebase-disconnected';
                
                setTimeout(() => {
                    statusElement.style.opacity = '0';
                    setTimeout(() => {
                        statusElement.style.display = 'none';
                    }, 500);
                }, 2000);
            }
        }

        function savePlayerToFirebase() {
            if (!firebaseConnected || !window.firebaseDatabase) return;
            
            try {
                const playerId = getUniquePlayerId();
                const playerRef = window.firebaseRef(window.firebaseDatabase, `players/${playerId}`);
                
                const playerData = {
                    id: playerId,
                    name: gameState.playerName,
                    balance: gameState.balance,
                    level: gameState.level,
                    totalTaps: gameState.totalTaps,
                    referrals: gameState.referrals.length,
                    country: gameState.country,
                    lastUpdate: Date.now(),
                    isOnline: true,
                    referralCode: gameState.referralCode,
                    telegramId: getTelegramUserId(),
                    browserFingerprint: getBrowserFingerprint()
                };
                
                window.firebaseSet(playerRef, playerData);
                
                // Remove any duplicate accounts
                removeDuplicateAccounts(playerId);
            } catch (error) {
                console.error('‚ùå Firebase ga saqlashda xatolik:', error);
            }
        }

        function loadPlayersFromFirebase() {
            if (!firebaseConnected || !window.firebaseDatabase) return;
            
            try {
                const playersRef = window.firebaseRef(window.firebaseDatabase, 'players');
                window.firebaseOnValue(playersRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const currentPlayerId = getUniquePlayerId();
                        globalPlayers = Object.values(data).filter(player => 
                            player.id !== currentPlayerId
                        );
                        
                        // Remove duplicates based on ID
                        const uniquePlayers = [];
                        const seenIds = new Set();
                        
                        globalPlayers.forEach(player => {
                            if (!seenIds.has(player.id)) {
                                seenIds.add(player.id);
                                uniquePlayers.push(player);
                            }
                        });
                        
                        globalPlayers = uniquePlayers;
                    }
                });
            } catch (error) {
                console.error('‚ùå Firebase dan yuklashda xatolik:', error);
                generateDemoPlayers();
            }
        }

        function generateDemoPlayers() {
            const names = [
                'CryptoKing', 'DragonMaster', 'CoinHunter', 'TapLegend', 'GoldDigger',
                'FastTapper', 'CoinCollector', 'DragonSlayer', 'TapMaster', 'CryptoMiner'
            ];
            
            const countries = ['UZ', 'RU', 'KZ', 'TR', 'KG', 'US', 'DE', 'FR'];
            globalPlayers = [];
            
            for (let i = 0; i < 10; i++) {
                const baseBalance = Math.floor(Math.random() * 50000) + 5000;
                const level = Math.max(1, Math.floor(baseBalance / 5000));
                const referrals = Math.floor(Math.random() * 20);
                
                globalPlayers.push({
                    id: 'demo_' + i,
                    name: names[i],
                    balance: baseBalance,
                    referrals: referrals,
                    level: level,
                    totalTaps: Math.floor(baseBalance * (1 + Math.random())),
                    country: countries[Math.floor(Math.random() * countries.length)],
                    isCurrentPlayer: false,
                    lastUpdate: Date.now() - Math.floor(Math.random() * 3600000),
                    isOnline: Math.random() > 0.3
                });
            }
        }

        function getUniquePlayerId() {
            const tgData = getTelegramUserData();
            
            // Priority 1: Telegram User ID (most reliable)
            if (tgData && tgData.id) {
                gameState.playerName = tgData.username;
                const telegramId = 'tg_' + tgData.telegramId;
                localStorage.setItem('dragonCoinPlayerId', telegramId);
                localStorage.setItem('dragonCoinTelegramId', tgData.telegramId);
                return telegramId;
            }
            
            // Priority 2: Check if we have stored Telegram ID
            const storedTgId = localStorage.getItem('dragonCoinTelegramId');
            if (storedTgId) {
                const telegramId = 'tg_' + storedTgId;
                localStorage.setItem('dragonCoinPlayerId', telegramId);
                return telegramId;
            }
            
            // Priority 3: Browser fingerprint + stored ID
            const browserFingerprint = getBrowserFingerprint();
            let storedId = localStorage.getItem('dragonCoinPlayerId');
            
            if (!storedId) {
                storedId = 'browser_' + browserFingerprint;
                localStorage.setItem('dragonCoinPlayerId', storedId);
            }
            
            return storedId;
        }

        function getTelegramUserData() {
            if (window.Telegram && window.Telegram.WebApp) {
                const user = window.Telegram.WebApp.initDataUnsafe?.user;
                if (user) {
                    return {
                        id: 'tg_' + user.id,
                        telegramId: user.id.toString(),
                        username: user.username || user.first_name || 'Telegram User',
                        firstName: user.first_name || '',
                        lastName: user.last_name || '',
                        languageCode: user.language_code || 'uz'
                    };
                }
            }
            return null;
        }

        function getTelegramUserId() {
            const tgData = getTelegramUserData();
            return tgData ? tgData.telegramId : null;
        }

        function getBrowserFingerprint() {
            // Create a unique browser fingerprint
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('Browser fingerprint', 2, 2);
            
            const fingerprint = [
                navigator.userAgent,
                navigator.language,
                screen.width + 'x' + screen.height,
                new Date().getTimezoneOffset(),
                canvas.toDataURL()
            ].join('|');
            
            // Create a simple hash
            let hash = 0;
            for (let i = 0; i < fingerprint.length; i++) {
                const char = fingerprint.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }
            
            return Math.abs(hash).toString(36);
        }

        function removeDuplicateAccounts(currentPlayerId) {
            if (!firebaseConnected || !window.firebaseDatabase) return;
            
            try {
                const playersRef = window.firebaseRef(window.firebaseDatabase, 'players');
                window.firebaseGet(playersRef).then((snapshot) => {
                    const data = snapshot.val();
                    if (!data) return;
                    
                    const currentTelegramId = getTelegramUserId();
                    const currentBrowserFingerprint = getBrowserFingerprint();
                    const currentPlayerName = gameState.playerName;
                    
                    const duplicatesToRemove = [];
                    const accountsToMerge = [];
                    
                    Object.entries(data).forEach(([playerId, playerData]) => {
                        if (playerId === currentPlayerId) return; // Skip current player
                        
                        // Check for duplicates based on multiple criteria
                        const isDuplicateByTelegram = currentTelegramId && playerData.telegramId === currentTelegramId;
                        const isDuplicateByBrowser = !currentTelegramId && playerData.browserFingerprint === currentBrowserFingerprint;
                        const isDuplicateByName = playerData.name === currentPlayerName && currentPlayerName !== 'Dragon Miner';
                        
                        if (isDuplicateByTelegram || isDuplicateByBrowser || isDuplicateByName) {
                            accountsToMerge.push({ id: playerId, data: playerData });
                            duplicatesToRemove.push(playerId);
                        }
                    });
                    
                    // Merge all duplicate accounts into current account
                    accountsToMerge.forEach(account => {
                        const playerData = account.data;
                        
                        // Keep the best stats from all accounts
                        gameState.balance = Math.max(gameState.balance, playerData.balance || 0);
                        gameState.level = Math.max(gameState.level, playerData.level || 1);
                        gameState.totalTaps = Math.max(gameState.totalTaps, playerData.totalTaps || 0);
                        gameState.referralEarnings = Math.max(gameState.referralEarnings, playerData.referralEarnings || 0);
                        
                        // Merge referrals without duplicates
                        if (playerData.referrals && Array.isArray(playerData.referrals)) {
                            playerData.referrals.forEach(ref => {
                                if (!gameState.referrals.find(r => r.id === ref.id || r.name === ref.name)) {
                                    gameState.referrals.push(ref);
                                }
                            });
                        }
                        
                        // Merge completed tasks
                        if (playerData.completedTasks) {
                            Object.keys(playerData.completedTasks).forEach(taskKey => {
                                if (playerData.completedTasks[taskKey]) {
                                    gameState.completedTasks[taskKey] = true;
                                }
                            });
                        }
                        
                        // Merge admin tasks
                        if (playerData.adminTasks && Array.isArray(playerData.adminTasks)) {
                            playerData.adminTasks.forEach(task => {
                                if (!gameState.adminTasks.find(t => t.id === task.id)) {
                                    gameState.adminTasks.push(task);
                                }
                            });
                        }
                        
                        console.log(`üîÑ Akkount birlashtirildi: ${account.id} -> ${currentPlayerId}`);
                    });
                    
                    // Remove all duplicate accounts
                    duplicatesToRemove.forEach(playerId => {
                        const duplicateRef = window.firebaseRef(window.firebaseDatabase, `players/${playerId}`);
                        window.firebaseSet(duplicateRef, null);
                        console.log(`üóëÔ∏è Dublikat akkount o'chirildi: ${playerId}`);
                    });
                    
                    if (accountsToMerge.length > 0) {
                        updateUI();
                        saveGameState();
                        showNotification(`‚úÖ ${accountsToMerge.length} ta dublikat akkount birlashtirildi!`, 'success');
                    }
                });
            } catch (error) {
                console.error('‚ùå Dublikatlarni tozalashda xatolik:', error);
            }
        }

        function detectCountryAndLanguage() {
            const userLang = navigator.language.toLowerCase();
            if (userLang.includes('ru')) {
                currentLanguage = 'ru';
                gameState.country = 'RU';
            } else if (userLang.includes('en')) {
                currentLanguage = 'en';
                gameState.country = 'US';
            } else {
                currentLanguage = 'uz';
                gameState.country = 'UZ';
            }
            updateLanguageDisplay();
            translatePage();
        }

        function updateLanguageDisplay() {
            document.getElementById('countryFlag').textContent = countryFlags[currentLanguage];
            document.getElementById('languageText').textContent = currentLanguage.toUpperCase();
        }

        function toggleLanguage() {
            const languages = ['uz', 'en', 'ru'];
            const currentIndex = languages.indexOf(currentLanguage);
            currentLanguage = languages[(currentIndex + 1) % languages.length];
            updateLanguageDisplay();
            translatePage();
            saveGameState();
        }

        function translatePage() {
            const elements = document.querySelectorAll('[data-translate]');
            elements.forEach(element => {
                const key = element.getAttribute('data-translate');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    element.textContent = translations[currentLanguage][key];
                }
            });
        }

        // Tap function
        function tapCoin(event) {
            const now = Date.now();
            
            if (now - lastTapTime < 50) return;
            lastTapTime = now;
            
            if (gameState.energy <= 0) {
                showEnergyWarning();
                return;
            }
            
            gameState.balance += gameState.tapPower;
            gameState.energy = Math.max(0, gameState.energy - 1);
            gameState.totalTaps++;
            
            createTapEffect(event, gameState.tapPower);
            animateCoin();
            
            if (!pendingUIUpdate) {
                pendingUIUpdate = true;
                setTimeout(() => {
                    updateUI();
                    pendingUIUpdate = false;
                }, 16);
            }
            
            checkLevelUp();
            
            if (now - gameState.lastSaveTime > 5000) {
                saveGameState();
                gameState.lastSaveTime = now;
            }
        }

        function createTapEffect(event, coins) {
            const coinContainer = document.querySelector('.coin-container');
            const rect = coinContainer.getBoundingClientRect();
            
            let effect = tapEffectPool.pop();
            if (!effect) {
                effect = document.createElement('div');
                effect.className = 'tap-effect';
            }
            
            const x = (event.clientX || event.touches?.[0]?.clientX || rect.left + rect.width/2) - rect.left;
            const y = (event.clientY || event.touches?.[0]?.clientY || rect.top + rect.height/2) - rect.top;
            
            effect.style.left = x + 'px';
            effect.style.top = y + 'px';
            effect.textContent = '+' + coins;
            
            coinContainer.appendChild(effect);
            
            setTimeout(() => {
                if (effect.parentNode) {
                    effect.parentNode.removeChild(effect);
                }
                tapEffectPool.push(effect);
            }, 1000);
        }

        function animateCoin() {
            const coin = document.getElementById('mainCoin');
            coin.classList.add('tap-animation');
            
            setTimeout(() => {
                coin.classList.remove('tap-animation');
            }, 50);
        }

        function showEnergyWarning() {
            const warning = document.getElementById('energyWarning');
            warning.style.display = 'block';
            
            setTimeout(() => {
                warning.style.display = 'none';
            }, 3000);
        }

        function showSection(sectionName) {
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => {
                section.style.display = 'none';
            });
            
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            const targetSection = document.getElementById(sectionName + 'Section');
            if (targetSection) {
                targetSection.style.display = 'block';
            }
            
            const activeTab = document.getElementById(sectionName + 'Tab');
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            if (sectionName === 'tasks') {
                updateTasksDisplay();
            } else if (sectionName === 'referral') {
                updateReferralDisplay();
            } else if (sectionName === 'leaderboard') {
                updateLeaderboard();
            }
        }

        function claimTask(taskType) {
            if (gameState.completedTasks[taskType]) {
                return;
            }
            
            let canClaim = false;
            let reward = 0;
            
            switch (taskType) {
                case 'taps':
                    canClaim = gameState.totalTaps >= 500;
                    reward = 1000;
                    break;
                case 'level':
                    canClaim = gameState.level >= 5;
                    reward = 2000;
                    break;
                case 'coins':
                    canClaim = gameState.balance >= 10000;
                    reward = 5000;
                    break;
                case 'referral':
                    canClaim = gameState.referrals.length >= 5;
                    reward = 3000;
                    break;
                case 'telegram':
                    // Open Telegram channel and mark as completed after 3 seconds
                    window.open('https://t.me/DragonCoinChannel', '_blank');
                    setTimeout(() => {
                        gameState.completedTasks[taskType] = true;
                        gameState.balance += 1500;
                        showNotification('‚úÖ Telegram kanalga obuna bo\'lganingiz uchun rahmat! +1500 DRC', 'success');
                        updateTasksDisplay();
                        updateUI();
                        saveGameState();
                    }, 3000);
                    return;
                case 'youtube':
                    // Open YouTube channel and mark as completed after 3 seconds
                    window.open('https://youtube.com/@DragonCoinOfficial', '_blank');
                    setTimeout(() => {
                        gameState.completedTasks[taskType] = true;
                        gameState.balance += 2000;
                        showNotification('‚úÖ YouTube kanalga obuna bo\'lganingiz uchun rahmat! +2000 DRC', 'success');
                        updateTasksDisplay();
                        updateUI();
                        saveGameState();
                    }, 3000);
                    return;
                case 'code':
                    const code = prompt('Videoda ko\'rsatilgan kodni kiriting:');
                    if (code && code.toUpperCase() === 'DRAGON2024') {
                        gameState.completedTasks[taskType] = true;
                        gameState.balance += 5000;
                        showNotification('‚úÖ To\'g\'ri kod! +5000 DRC olindi!', 'success');
                        updateTasksDisplay();
                        updateUI();
                        saveGameState();
                    } else {
                        showNotification('‚ùå Noto\'g\'ri kod! Videoni qaytadan ko\'ring.', 'error');
                    }
                    return;
            }
            
            if (canClaim) {
                gameState.completedTasks[taskType] = true;
                gameState.balance += reward;
                
                showNotification(`‚úÖ Vazifa bajarildi! +${reward} DRC olindi!`, 'success');
                
                updateTasksDisplay();
                updateUI();
                saveGameState();
            } else {
                showNotification('‚ùå Vazifa hali bajarilmagan!', 'error');
            }
        }

        function updateTasksDisplay() {
            // Safely update progress displays
            const tapProgress = document.getElementById('tapProgress');
            const currentLevel = document.getElementById('currentLevel');
            const coinProgress = document.getElementById('coinProgress');
            const referralProgress = document.getElementById('referralProgress');
            
            if (tapProgress) tapProgress.textContent = Math.min(gameState.totalTaps, 500);
            if (currentLevel) currentLevel.textContent = gameState.level;
            if (coinProgress) coinProgress.textContent = Math.min(gameState.balance, 10000);
            if (referralProgress) referralProgress.textContent = gameState.referrals.length;
            
            updateTaskStatus('taps', gameState.totalTaps >= 500);
            updateTaskStatus('level', gameState.level >= 5);
            updateTaskStatus('coins', gameState.balance >= 10000);
            updateTaskStatus('referral', gameState.referrals.length >= 5);
            updateTaskStatus('telegram', gameState.completedTasks.telegram);
            updateTaskStatus('youtube', gameState.completedTasks.youtube);
            updateTaskStatus('code', gameState.completedTasks.code);
            
            // Show/hide admin tasks section
            const adminTasksSection = document.getElementById('adminTasksSection');
            if (adminTasksSection) {
                if (gameState.adminTasks && gameState.adminTasks.length > 0) {
                    adminTasksSection.style.display = 'block';
                    updateAdminTasksDisplay();
                } else {
                    adminTasksSection.style.display = 'none';
                }
            }
            
            updateCompletedTasksDisplay();
        }

        function updateTaskStatus(taskType, canClaim) {
            const taskElement = document.getElementById(taskType + 'Task');
            const conditionElement = document.getElementById(taskType + 'Condition');
            
            // Check if elements exist before accessing classList
            if (!taskElement || !conditionElement) {
                return;
            }
            
            if (gameState.completedTasks[taskType]) {
                taskElement.classList.add('completed');
                conditionElement.classList.remove('condition-pending');
                conditionElement.classList.add('condition-completed');
            } else if (canClaim) {
                taskElement.classList.add('task-ready');
                conditionElement.classList.remove('condition-pending');
                conditionElement.classList.add('condition-completed');
            } else {
                taskElement.classList.remove('task-ready', 'completed');
                conditionElement.classList.remove('condition-completed');
                conditionElement.classList.add('condition-pending');
            }
        }

        function updateCompletedTasksDisplay() {
            const completedTasksSection = document.getElementById('completedTasksSection');
            const completedTasksList = document.getElementById('completedTasksList');
            const completedTasksCount = document.getElementById('completedTasksCount');
            
            const completedTasks = Object.entries(gameState.completedTasks).filter(([key, value]) => value);
            
            if (completedTasks.length > 0) {
                completedTasksSection.style.display = 'block';
                completedTasksCount.textContent = completedTasks.length;
                
                const taskNames = {
                    taps: { name: '500 marta tap qiling', reward: 1000 },
                    level: { name: 'Level 5 ga yeting', reward: 2000 },
                    coins: { name: '10000 coin to\'plang', reward: 5000 },
                    referral: { name: '5 ta do\'st taklif qiling', reward: 3000 }
                };
                
                completedTasksList.innerHTML = completedTasks.map(([taskType]) => {
                    const task = taskNames[taskType];
                    return `
                        <div class="completed-task-item">
                            <div class="completed-task-text">${task.name}</div>
                            <div class="completed-task-reward">+${task.reward} DRC</div>
                            <div class="completed-task-check">‚úÖ</div>
                        </div>
                    `;
                }).join('');
            } else {
                completedTasksSection.style.display = 'none';
            }
        }

        function updateReferralDisplay() {
            document.getElementById('userReferralCode').textContent = gameState.referralCode;
            document.getElementById('totalReferrals').textContent = gameState.referrals.length;
            document.getElementById('referralEarnings').textContent = gameState.referralEarnings;
            
            const referralList = document.getElementById('referralList');
            if (gameState.referrals.length === 0) {
                referralList.innerHTML = '<div style="text-align: center; color: #ccc; padding: 20px;">Hali referrallaringiz yo\'q. Do\'stlaringizni taklif qiling!</div>';
            } else {
                referralList.innerHTML = gameState.referrals.map(referral => `
                    <div style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 12px; margin: 8px 0; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: bold;">${referral.name}</div>
                            <div style="font-size: 12px; color: #ccc;">Level ${referral.level} ‚Ä¢ ${referral.totalTaps} taps</div>
                        </div>
                        <div style="color: #00ff88; font-weight: bold;">+${referral.earnings} DRC</div>
                    </div>
                `).join('');
            }
        }

        function updateLeaderboard() {
            const leaderboardList = document.getElementById('leaderboardList');
            const playerRank = document.getElementById('playerRank');
            const currentPlayerId = getUniquePlayerId();
            
            // Ultra-strict duplicate detection and removal
            const uniquePlayersMap = new Map();
            const seenTelegramIds = new Set();
            const seenBrowserFingerprints = new Set();
            const seenNameBalanceCombos = new Set();
            
            // Process global players with ultra-strict duplicate detection
            globalPlayers.forEach(player => {
                if (!player.id || player.id === currentPlayerId) return;
                
                // Skip if player doesn't have valid data
                if (!player.name || typeof player.balance !== 'number' || player.name === 'Dragon Miner') return;
                
                let isDuplicate = false;
                
                // Check Telegram ID duplicates
                if (player.telegramId) {
                    if (seenTelegramIds.has(player.telegramId)) {
                        isDuplicate = true;
                    } else {
                        seenTelegramIds.add(player.telegramId);
                    }
                }
                
                // Check browser fingerprint duplicates (only if no Telegram ID)
                if (!isDuplicate && !player.telegramId && player.browserFingerprint) {
                    if (seenBrowserFingerprints.has(player.browserFingerprint)) {
                        isDuplicate = true;
                    } else {
                        seenBrowserFingerprints.add(player.browserFingerprint);
                    }
                }
                
                // Check name+balance combination duplicates
                const nameBalanceCombo = `${player.name}_${player.balance}`;
                if (!isDuplicate) {
                    if (seenNameBalanceCombos.has(nameBalanceCombo)) {
                        isDuplicate = true;
                    } else {
                        seenNameBalanceCombos.add(nameBalanceCombo);
                    }
                }
                
                // Only add if not duplicate
                if (!isDuplicate) {
                    uniquePlayersMap.set(player.id, {
                        ...player,
                        isCurrentPlayer: false
                    });
                }
            });
            
            // Add current player
            uniquePlayersMap.set(currentPlayerId, {
                id: currentPlayerId,
                name: gameState.playerName,
                balance: gameState.balance,
                referrals: gameState.referrals.length,
                level: gameState.level,
                totalTaps: gameState.totalTaps,
                country: gameState.country,
                isCurrentPlayer: true,
                isOnline: true,
                telegramId: getTelegramUserId(),
                browserFingerprint: getBrowserFingerprint()
            });
            
            // Convert to array and sort by balance
            const allPlayers = Array.from(uniquePlayersMap.values())
                .filter(player => player.name && typeof player.balance === 'number' && player.balance >= 0)
                .sort((a, b) => (b.balance || 0) - (a.balance || 0));
            
            // Find current player rank
            const currentPlayerIndex = allPlayers.findIndex(p => p.isCurrentPlayer);
            playerRank.textContent = `#${currentPlayerIndex + 1}`;
            
            // Display top 10
            const top10 = allPlayers.slice(0, 10);
            leaderboardList.innerHTML = top10.map((player, index) => {
                const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : 'rank-other';
                const isCurrentPlayer = player.isCurrentPlayer ? 'style="border: 2px solid #00ff88;"' : '';
                
                return `
                    <div class="condition-item" ${isCurrentPlayer}>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px;" class="${rankClass}">
                                ${index + 1}
                            </div>
                            <div style="cursor: pointer;" onclick="showPlayerDetails('${player.id}', '${player.name}', ${player.balance || 0}, ${player.level || 1}, ${player.totalTaps || 0}, ${player.referrals || 0}, '${player.country || 'UZ'}', ${player.isOnline || false})">
                                <div style="font-weight: bold; color: #00ff88; text-decoration: underline;">${player.name} ${player.isCurrentPlayer ? '(Siz)' : ''}</div>
                                <div style="font-size: 12px; color: #ccc;">
                                    Level ${player.level || 1} ‚Ä¢ ${player.country || 'UZ'} 
                                    ${player.isOnline ? 'üü¢' : 'üî¥'}
                                </div>
                            </div>
                        </div>
                        <div style="font-size: 18px; font-weight: bold; color: #00ff88;">
                            ${(player.balance || 0).toLocaleString()} DRC
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showLeaderboard(type) {
            const coinsTab = document.getElementById('coinsLeaderboard');
            const referralsTab = document.getElementById('referralsLeaderboard');
            
            if (type === 'coins') {
                coinsTab.classList.add('active');
                referralsTab.classList.remove('active');
            } else {
                referralsTab.classList.add('active');
                coinsTab.classList.remove('active');
            }
            
            updateLeaderboard();
        }

        function copyReferralLink() {
            const referralCode = gameState.referralCode;
            const link = `https://t.me/Dragon_coin_money_bot?start=ref_${referralCode}`;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(link).then(() => {
                    showNotification('‚úÖ Referral link nusxalandi!', 'success');
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = link;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('‚úÖ Referral link nusxalandi!', 'success');
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function checkLevelUp() {
            const currentLevelData = levelSystem[gameState.level];
            const nextLevelData = levelSystem[gameState.level + 1];
            
            if (nextLevelData && gameState.totalTaps >= nextLevelData.tapsRequired) {
                gameState.level++;
                showNotification(`üéâ Level Up! Level ${gameState.level} - ${levelSystem[gameState.level].name}`, 'success');
                updateUI();
            }
        }

        function updateUI() {
            // Update balance
            const balanceEl = document.getElementById('balance');
            if (balanceEl) balanceEl.textContent = gameState.balance.toLocaleString();
            
            // Update energy
            const energyPercentage = (gameState.energy / gameState.maxEnergy) * 100;
            const energyProgress = document.getElementById('energyProgress');
            const energyText = document.getElementById('energyText');
            if (energyProgress) energyProgress.style.width = energyPercentage + '%';
            if (energyText) energyText.textContent = `${gameState.energy}/${gameState.maxEnergy}`;
            
            // Update stats
            const tapPowerEl = document.getElementById('tapPower');
            const totalTapsEl = document.getElementById('totalTaps');
            const levelEl = document.getElementById('level');
            const referralCountEl = document.getElementById('referralCount');
            
            if (tapPowerEl) tapPowerEl.textContent = gameState.tapPower;
            if (totalTapsEl) totalTapsEl.textContent = gameState.totalTaps.toLocaleString();
            if (levelEl) levelEl.textContent = gameState.level;
            if (referralCountEl) referralCountEl.textContent = gameState.referrals.length;
            
            // Update level info
            const currentLevelData = levelSystem[gameState.level];
            const nextLevelData = levelSystem[gameState.level + 1];
            
            const levelBadge = document.getElementById('levelBadge');
            const levelName = document.getElementById('levelName');
            const currentLevelDisplay = document.getElementById('currentLevelDisplay');
            
            if (levelBadge) levelBadge.textContent = `Level ${gameState.level}`;
            if (levelName) levelName.textContent = currentLevelData.name;
            if (currentLevelDisplay) currentLevelDisplay.textContent = `Level ${gameState.level} - ${currentLevelData.name}`;
            
            const nextLevelDisplay = document.getElementById('nextLevelDisplay');
            const currentTapsDisplay = document.getElementById('currentTapsDisplay');
            const requiredTapsDisplay = document.getElementById('requiredTapsDisplay');
            const levelProgressBar = document.getElementById('levelProgressBar');
            
            if (nextLevelData) {
                if (nextLevelDisplay) nextLevelDisplay.textContent = `Next: Level ${gameState.level + 1} - ${nextLevelData.name}`;
                if (currentTapsDisplay) currentTapsDisplay.textContent = `${gameState.totalTaps} taps`;
                if (requiredTapsDisplay) requiredTapsDisplay.textContent = `${nextLevelData.tapsRequired} taps kerak`;
                
                const progress = ((gameState.totalTaps - currentLevelData.tapsRequired) / (nextLevelData.tapsRequired - currentLevelData.tapsRequired)) * 100;
                if (levelProgressBar) levelProgressBar.style.width = Math.max(0, Math.min(100, progress)) + '%';
            } else {
                if (nextLevelDisplay) nextLevelDisplay.textContent = 'Max Level!';
                if (levelProgressBar) levelProgressBar.style.width = '100%';
            }
        }

        function saveGameState() {
            localStorage.setItem('dragonCoinGameState', JSON.stringify(gameState));
            localStorage.setItem('dragonCoinLanguage', currentLanguage);
            
            if (firebaseConnected) {
                savePlayerToFirebase();
            }
        }

        function loadGameState() {
            const saved = localStorage.getItem('dragonCoinGameState');
            const savedLanguage = localStorage.getItem('dragonCoinLanguage');
            
            if (saved) {
                const loadedState = JSON.parse(saved);
                gameState = { ...gameState, ...loadedState };
            }
            
            if (savedLanguage) {
                currentLanguage = savedLanguage;
                updateLanguageDisplay();
                translatePage();
            }
        }

        // Energy regeneration
        function startEnergyRegeneration() {
            setInterval(() => {
                if (gameState.energy < gameState.maxEnergy) {
                    gameState.energy = Math.min(gameState.maxEnergy, gameState.energy + 1);
                    updateUI();
                }
            }, 5000); // Regenerate 1 energy every 5 seconds
        }

        // Admin functions
        function addAdminTask() {
            const title = document.getElementById('taskTitle').value;
            const description = document.getElementById('taskDescription').value;
            const reward = parseInt(document.getElementById('taskReward').value);
            const type = document.getElementById('taskType').value;
            const link = document.getElementById('taskLink').value;
            const code = document.getElementById('taskCode').value;
            
            if (!title || !reward) {
                showNotification('‚ùå Vazifa nomi va mukofot kiritilishi shart!', 'error');
                return;
            }
            
            const newTask = {
                id: 'admin_' + Date.now(),
                title: title,
                description: description,
                reward: reward,
                type: type,
                link: link,
                code: code.toUpperCase(),
                completed: false
            };
            
            gameState.adminTasks.push(newTask);
            
            // Clear form
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDescription').value = '';
            document.getElementById('taskReward').value = '';
            document.getElementById('taskLink').value = '';
            document.getElementById('taskCode').value = '';
            
            updateAdminTasksDisplay();
            saveGameState();
            
            showNotification('‚úÖ Yangi vazifa qo\'shildi!', 'success');
        }
        
        function updateAdminTasksDisplay() {
            const adminTasksDisplay = document.getElementById('adminTasksDisplay');
            const adminTasksList = document.getElementById('adminTasksList');
            
            if (gameState.adminTasks.length === 0) {
                adminTasksDisplay.innerHTML = '<div style="text-align: center; color: #ccc; padding: 20px;">Hali admin vazifalari qo\'shilmagan</div>';
                if (adminTasksList) adminTasksList.innerHTML = '';
                return;
            }
            
            // Display in admin panel
            adminTasksDisplay.innerHTML = gameState.adminTasks.map(task => `
                <div class="condition-item" style="margin-bottom: 10px;">
                    <div class="condition-text">
                        <div style="font-weight: bold;">${task.title}</div>
                        <div style="font-size: 12px; color: #ccc;">${task.description}</div>
                        <div style="font-size: 11px; color: #999;">Turi: ${task.type} | Mukofot: ${task.reward} DRC</div>
                    </div>
                    <button onclick="removeAdminTask('${task.id}')" style="background: rgba(255, 107, 53, 0.2); color: #ff6b35; border: 1px solid #ff6b35; padding: 5px 10px; border-radius: 5px; cursor: pointer;">
                        üóëÔ∏è O'chirish
                    </button>
                </div>
            `).join('');
            
            // Display in tasks section
            if (adminTasksList) {
                adminTasksList.innerHTML = gameState.adminTasks.map(task => `
                    <div class="condition-item task-button" onclick="claimAdminTask('${task.id}')" id="adminTask_${task.id}">
                        <div class="condition-text">
                            <div>${task.title}</div>
                            <div style="font-size: 12px; color: #ccc;">${task.description}</div>
                        </div>
                        <div class="condition-reward">+${task.reward} DRC</div>
                        <div class="condition-status condition-pending" id="adminCondition_${task.id}"></div>
                    </div>
                `).join('');
            }
        }
        
        function claimAdminTask(taskId) {
            const task = gameState.adminTasks.find(t => t.id === taskId);
            if (!task || task.completed) return;
            
            if (task.type === 'link' && task.link) {
                window.open(task.link, '_blank');
                setTimeout(() => {
                    task.completed = true;
                    gameState.balance += task.reward;
                    showNotification(`‚úÖ ${task.title} bajarildi! +${task.reward} DRC`, 'success');
                    updateAdminTasksDisplay();
                    updateUI();
                    saveGameState();
                }, 3000);
            } else if (task.type === 'code') {
                const userCode = prompt(`${task.title}\n\nKodni kiriting:`);
                if (userCode && userCode.toUpperCase() === task.code) {
                    task.completed = true;
                    gameState.balance += task.reward;
                    showNotification(`‚úÖ To'g'ri kod! +${task.reward} DRC olindi!`, 'success');
                    updateAdminTasksDisplay();
                    updateUI();
                    saveGameState();
                } else {
                    showNotification('‚ùå Noto\'g\'ri kod!', 'error');
                }
            } else {
                // Subscribe type or link without URL
                task.completed = true;
                gameState.balance += task.reward;
                showNotification(`‚úÖ ${task.title} bajarildi! +${task.reward} DRC`, 'success');
                updateAdminTasksDisplay();
                updateUI();
                saveGameState();
            }
        }
        
        function removeAdminTask(taskId) {
            gameState.adminTasks = gameState.adminTasks.filter(task => task.id !== taskId);
            updateAdminTasksDisplay();
            saveGameState();
            showNotification('‚úÖ Vazifa o\'chirildi!', 'success');
        }
        
        function clearAllTasks() {
            gameState.adminTasks = [];
            updateAdminTasksDisplay();
            saveGameState();
            showNotification('‚úÖ Barcha vazifalar o\'chirildi!', 'success');
        }
        
        function exportGameData() {
            const data = {
                gameState: gameState,
                globalPlayers: globalPlayers,
                exportDate: new Date().toISOString(),
                totalPlayers: globalPlayers.length + 1,
                playerStats: {
                    balance: gameState.balance,
                    level: gameState.level,
                    totalTaps: gameState.totalTaps,
                    referrals: gameState.referrals.length,
                    completedTasks: Object.values(gameState.completedTasks).filter(Boolean).length
                }
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dragon-coin-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('‚úÖ Ma\'lumotlar muvaffaqiyatli eksport qilindi!', 'success');
        }

        // Initialize game
        function initGame() {
            detectCountryAndLanguage();
            
            // Load existing account data if available
            loadExistingAccount().then(() => {
                loadGameState();
                
                // Check if user is admin (you can modify this logic)
                const adminIds = ['tg_123456789', 'local_admin']; // Add your admin IDs here
                if (adminIds.includes(getUniquePlayerId())) {
                    gameState.isAdmin = true;
                    document.getElementById('adminTab').style.display = 'block';
                }
                
                updateUI();
                updateTasksDisplay();
                updateAdminTasksDisplay();
                startEnergyRegeneration();
                initializeFirebaseConnection();
                
                // Process referral if exists
                processReferralFromURL();
                
                // Auto-save every 30 seconds
                setInterval(saveGameState, 30000);
            });
        }

        function loadExistingAccount() {
            return new Promise((resolve) => {
                if (!firebaseConnected) {
                    resolve();
                    return;
                }
                
                try {
                    const currentTelegramId = getTelegramUserId();
                    const currentBrowserFingerprint = getBrowserFingerprint();
                    const currentPlayerName = gameState.playerName;
                    
                    const playersRef = window.firebaseRef(window.firebaseDatabase, 'players');
                    window.firebaseGet(playersRef).then((snapshot) => {
                        const data = snapshot.val();
                        if (!data) {
                            resolve();
                            return;
                        }
                        
                        // Find all matching accounts
                        const matchingAccounts = [];
                        Object.entries(data).forEach(([playerId, playerData]) => {
                            const matchesTelegram = currentTelegramId && playerData.telegramId === currentTelegramId;
                            const matchesBrowser = !currentTelegramId && playerData.browserFingerprint === currentBrowserFingerprint;
                            const matchesName = playerData.name === currentPlayerName && currentPlayerName !== 'Dragon Miner';
                            
                            if (matchesTelegram || matchesBrowser || matchesName) {
                                matchingAccounts.push({ id: playerId, data: playerData });
                            }
                        });
                        
                        if (matchingAccounts.length > 0) {
                            // Find the best account (highest balance or level)
                            const bestAccount = matchingAccounts.reduce((best, current) => {
                                const bestScore = (best.data.balance || 0) + (best.data.level || 1) * 1000 + (best.data.totalTaps || 0) * 0.1;
                                const currentScore = (current.data.balance || 0) + (current.data.level || 1) * 1000 + (current.data.totalTaps || 0) * 0.1;
                                return currentScore > bestScore ? current : best;
                            });
                            
                            // Merge all accounts into the best one
                            matchingAccounts.forEach(account => {
                                if (account.id !== bestAccount.id) {
                                    const playerData = account.data;
                                    
                                    // Merge stats
                                    bestAccount.data.balance = Math.max(bestAccount.data.balance || 0, playerData.balance || 0);
                                    bestAccount.data.level = Math.max(bestAccount.data.level || 1, playerData.level || 1);
                                    bestAccount.data.totalTaps = Math.max(bestAccount.data.totalTaps || 0, playerData.totalTaps || 0);
                                    bestAccount.data.referralEarnings = Math.max(bestAccount.data.referralEarnings || 0, playerData.referralEarnings || 0);
                                    
                                    // Merge referrals
                                    if (playerData.referrals && Array.isArray(playerData.referrals)) {
                                        bestAccount.data.referrals = bestAccount.data.referrals || [];
                                        playerData.referrals.forEach(ref => {
                                            if (!bestAccount.data.referrals.find(r => r.id === ref.id || r.name === ref.name)) {
                                                bestAccount.data.referrals.push(ref);
                                            }
                                        });
                                    }
                                    
                                    // Merge completed tasks
                                    if (playerData.completedTasks) {
                                        bestAccount.data.completedTasks = bestAccount.data.completedTasks || {};
                                        Object.keys(playerData.completedTasks).forEach(taskKey => {
                                            if (playerData.completedTasks[taskKey]) {
                                                bestAccount.data.completedTasks[taskKey] = true;
                                            }
                                        });
                                    }
                                    
                                    // Remove duplicate account
                                    const duplicateRef = window.firebaseRef(window.firebaseDatabase, `players/${account.id}`);
                                    window.firebaseSet(duplicateRef, null);
                                    console.log(`üóëÔ∏è Dublikat akkount o'chirildi: ${account.id}`);
                                }
                            });
                            
                            // Update the best account in Firebase
                            const bestAccountRef = window.firebaseRef(window.firebaseDatabase, `players/${bestAccount.id}`);
                            window.firebaseSet(bestAccountRef, bestAccount.data);
                            
                            // Load the merged account data
                            gameState.balance = bestAccount.data.balance || 0;
                            gameState.level = bestAccount.data.level || 1;
                            gameState.totalTaps = bestAccount.data.totalTaps || 0;
                            gameState.referralEarnings = bestAccount.data.referralEarnings || 0;
                            gameState.referrals = bestAccount.data.referrals || [];
                            gameState.completedTasks = bestAccount.data.completedTasks || gameState.completedTasks;
                            gameState.referralCode = bestAccount.data.referralCode || gameState.referralCode;
                            gameState.playerName = bestAccount.data.name || gameState.playerName;
                            gameState.adminTasks = bestAccount.data.adminTasks || [];
                            
                            // Update localStorage with correct ID
                            localStorage.setItem('dragonCoinPlayerId', bestAccount.id);
                            
                            console.log('‚úÖ Akkount yuklandi va dublikatlar tozalandi:', bestAccount.id);
                            if (matchingAccounts.length > 1) {
                                showNotification(`‚úÖ ${matchingAccounts.length - 1} ta dublikat akkount birlashtirildi!`, 'success');
                            } else {
                                showNotification('‚úÖ Akkountingiz muvaffaqiyatli yuklandi!', 'success');
                            }
                        }
                        
                        resolve();
                    }).catch(() => {
                        resolve();
                    });
                } catch (error) {
                    console.error('‚ùå Akkount yuklashda xatolik:', error);
                    resolve();
                }
            });
        }
        
        function processReferralFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const startParam = urlParams.get('start');
            
            if (startParam && startParam.startsWith('ref_')) {
                const referralCode = startParam.substring(4);
                if (referralCode && !gameState.referredBy) {
                    gameState.referredBy = referralCode;
                    // Add referral bonus
                    gameState.balance += 500;
                    showNotification('üéâ Referral bonusi! +500 DRC olindi!', 'success');
                    saveGameState();
                }
            }
        }

        function showPlayerDetails(playerId, playerName, balance, level, totalTaps, referrals, country, isOnline) {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(10px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                animation: fadeIn 0.3s ease;
            `;
            
            // Get level name
            const levelData = levelSystem[level] || { name: 'Unknown', color: '#ffffff' };
            
            // Calculate next level progress
            const nextLevelData = levelSystem[level + 1];
            let progressText = '';
            if (nextLevelData) {
                const currentLevelTaps = levelSystem[level].tapsRequired;
                const progress = ((totalTaps - currentLevelTaps) / (nextLevelData.tapsRequired - currentLevelTaps)) * 100;
                progressText = `
                    <div style="margin: 15px 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Level ${level + 1} uchun:</span>
                            <span>${Math.max(0, Math.min(100, progress)).toFixed(1)}%</span>
                        </div>
                        <div style="background: rgba(255, 255, 255, 0.1); border-radius: 10px; height: 8px; overflow: hidden;">
                            <div style="height: 100%; background: linear-gradient(90deg, #ff6b35, #f7931e); border-radius: 10px; width: ${Math.max(0, Math.min(100, progress))}%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                `;
            } else {
                progressText = '<div style="text-align: center; color: #00ff88; font-weight: bold; margin: 15px 0;">üèÜ MAX LEVEL!</div>';
            }
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(26, 10, 26, 0.9));
                    border: 2px solid rgba(0, 255, 136, 0.3);
                    border-radius: 20px;
                    padding: 30px;
                    max-width: 400px;
                    width: 90%;
                    box-shadow: 0 0 50px rgba(0, 255, 136, 0.3);
                    position: relative;
                    animation: slideIn 0.3s ease;
                ">
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        position: absolute;
                        top: 15px;
                        right: 15px;
                        background: rgba(255, 107, 53, 0.2);
                        border: 1px solid #ff6b35;
                        color: #ff6b35;
                        border-radius: 50%;
                        width: 35px;
                        height: 35px;
                        cursor: pointer;
                        font-size: 18px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">√ó</button>
                    
                    <div style="text-align: center; margin-bottom: 25px;">
                        <div style="
                            width: 80px;
                            height: 80px;
                            background: linear-gradient(45deg, #ff6b35, #f7931e);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 40px;
                            margin: 0 auto 15px auto;
                            box-shadow: 0 0 30px rgba(255, 107, 53, 0.5);
                        ">üêâ</div>
                        <h2 style="color: #00ff88; margin: 0; font-size: 24px;">${playerName}</h2>
                        <div style="color: #ccc; font-size: 14px; margin-top: 5px;">
                            ${country} ${isOnline ? 'üü¢ Online' : 'üî¥ Offline'}
                        </div>
                    </div>
                    
                    <div style="background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center;">
                            <div>
                                <div style="font-size: 24px; font-weight: bold; color: #00ff88;">${balance.toLocaleString()}</div>
                                <div style="font-size: 12px; color: #ccc;">Dragon Coins</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: bold; color: ${levelData.color};">${level}</div>
                                <div style="font-size: 12px; color: #ccc;">Level - ${levelData.name}</div>
                            </div>
                            <div>
                                <div style="font-size: 20px; font-weight: bold; color: #ff6b35;">${totalTaps.toLocaleString()}</div>
                                <div style="font-size: 12px; color: #ccc;">Jami Taplar</div>
                            </div>
                            <div>
                                <div style="font-size: 20px; font-weight: bold; color: #f7931e;">${referrals}</div>
                                <div style="font-size: 12px; color: #ccc;">Referrallar</div>
                            </div>
                        </div>
                        
                        ${progressText}
                    </div>
                    
                    <div style="text-align: center;">
                        <button onclick="this.parentElement.parentElement.remove()" style="
                            background: linear-gradient(45deg, #00ff88, #00cc6a);
                            color: #000;
                            border: none;
                            padding: 12px 30px;
                            border-radius: 25px;
                            font-weight: bold;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            Yopish
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Start the game when page loads
        window.addEventListener('load', initGame);
        
        // Save before page unload
        window.addEventListener('beforeunload', saveGameState);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96e068b6d3d4e0de',t:'MTc1NTAwNjI4My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
