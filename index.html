<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: blob: 'unsafe-inline' 'unsafe-eval'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://*.gstatic.com https://*.googleapis.com https://telegram.org; connect-src 'self' https://*.firebasedatabase.app wss://*.firebasedatabase.app https://*.firebaseio.com wss://*.firebaseio.com https://*.googleapis.com https://*.gstatic.com https://telegram.org wss:; frame-src 'self' https://*.firebaseapp.com https://*.googleapis.com https://telegram.org; img-src 'self' data: https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; object-src 'none'; base-uri 'self';">
    <title>Dragon Coin - Tap to Earn</title>

    <!-- ====== FIX: favicon to avoid 404 ====== -->
    <!-- Place a favicon.png (or change href) in your project root -->
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=">
    <!-- Placeholder globals to avoid inline-onclick ReferenceError before the module loads -->
    <script>
        window.showSection = window.showSection || function(section){ console.warn('showSection not initialized yet:', section); };
        window.tapCoin = window.tapCoin || function(e){ console.warn('tapCoin not initialized yet'); };
        window.copyReferralLink = window.copyReferralLink || function(){ console.warn('copyReferralLink not initialized yet'); };
    </script>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        /* (Original CSS kept intact) */
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background:
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%),
                linear-gradient(135deg, #0a0a0f 0%, #1a0a1a 25%, #0f0a1a 50%, #1a1a0f 75%, #0a0f1a 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            position: relative;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0; left:0; width:100%; height:100%;
            background:
                repeating-linear-gradient(90deg, transparent, transparent 98px, rgba(0,255,136,0.03) 100px),
                repeating-linear-gradient(0deg, transparent, transparent 98px, rgba(255,107,53,0.03) 100px);
            pointer-events: none; z-index: -1;
        }
        .header { background: rgba(0,0,0,0.3); backdrop-filter: blur(20px); padding:15px 20px; display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid rgba(0,255,136,0.3); }
        .firebase-status { position: fixed; top:70px; left:20px; padding:8px 15px; border-radius:20px; font-size:12px; font-weight:bold; z-index:100; transition: all .5s ease; opacity:1;}
        .firebase-connected{ background: rgba(0,255,136,0.2); color:#00ff88; border:1px solid #00ff88; }
        .firebase-disconnected{ background: rgba(255,107,53,0.2); color:#ff6b35; border:1px solid #ff6b35; }
        .user-info { display:flex; align-items:center; gap:10px; }
        .avatar { width:40px; height:40px; background: linear-gradient(45deg,#ff6b35,#f7931e); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:20px; }
        .level-badge { background:#00ff88; color:#000; padding:4px 12px; border-radius:20px; font-size:12px; font-weight:bold; }
        .energy-bar { background: rgba(255,255,255,0.1); border-radius:10px; padding:8px 15px; display:flex; align-items:center; gap:10px; }
        .energy-fill { width:100px; height:6px; background:rgba(255,255,255,0.2); border-radius:3px; overflow:hidden; }
        .energy-progress { height:100%; background:linear-gradient(90deg,#00ff88,#00cc6a); border-radius:3px; transition: width .3s ease; }

        .main-container { padding:20px; text-align:center; }
        .navigation-tabs { display:flex; justify-content:center; gap:8px; margin-bottom:20px; flex-wrap:wrap; }
        .nav-tab { background:rgba(255,255,255,0.1); border:2px solid rgba(255,255,255,0.2); color:#fff; padding:10px 16px; border-radius:25px; font-size:14px; font-weight:bold; cursor:pointer; transition:all .3s ease; backdrop-filter: blur(10px); }
        .nav-tab:hover{ background:rgba(255,255,255,0.15); border-color: rgba(0,255,136,0.5); box-shadow: 0 0 20px rgba(0,255,136,0.3); }
        .nav-tab.active{ background: linear-gradient(45deg,#00ff88,#00cc6a); color:#000; border-color:#00ff88; box-shadow:0 0 30px rgba(0,255,136,0.6); }
        .balance-display { margin-bottom:30px; }
        .balance-amount { font-size:48px; font-weight:bold; color:#00ff88; margin-bottom:5px; text-shadow: 0 0 10px #00ff88,0 0 20px #00ff88; animation: balanceGlow 3s ease-in-out infinite alternate; }
        @keyframes balanceGlow { 0%{ text-shadow:0 0 10px #00ff88; } 100%{ text-shadow:0 0 60px #00ff88; } }

        .coin-container { position:relative; margin:40px auto; width:280px; height:280px; perspective:1000px; }
        .main-coin { width:280px; height:280px; background: linear-gradient(135deg,#FFD700 0%,#FFA500 25%,#FFD700 50%); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:120px; cursor:pointer; transition:transform .05s ease; position:relative; overflow:hidden; border:8px solid #FFA500; box-shadow:0 20px 40px rgba(255,165,0,0.4); user-select:none; touch-action:manipulation; will-change: transform; backface-visibility:hidden;}
        .main-coin::before { content:''; position:absolute; top:15%; left:15%; width:30%; height:30%; background: radial-gradient(circle, rgba(255,255,255,0.6) 0%, transparent 70%); border-radius:50%; z-index:1; }
        .main-coin:hover { transform: scale(1.02); } .main-coin:active { transform: scale(0.96) !important; }
        .main-coin.tap-animation { transform: scale(0.94); transition: transform .03s ease-out; }

        .tap-effect { position:absolute; color:#00ff88; font-size:28px; font-weight:bold; pointer-events:none; text-shadow:0 0 15px #00ff88; animation:neonFloatUp 1s ease-out forwards; z-index:10; }
        @keyframes neonFloatUp { 0%{ opacity:1; transform:translateY(0) scale(1); } 100%{ opacity:0; transform:translateY(-80px) scale(0.8); } }

        .stats-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:15px; margin:30px 0; }
        .stat-card{ background:rgba(255,255,255,0.05); backdrop-filter: blur(15px); border-radius:15px; padding:20px; border:1px solid rgba(0,255,136,0.3); }
        .stat-value{ font-size:24px; font-weight:bold; color:#00ff88; } .stat-label{ font-size:12px; color:#ccc; margin-top:5px; }

        .conditions-panel{ background:rgba(255,255,255,0.1); border-radius:15px; padding:20px; margin:20px 0; text-align:left; }
        .condition-item{ display:flex; justify-content:space-between; align-items:center; padding:15px; border-bottom:1px solid rgba(255,255,255,0.1); border-radius:10px; margin-bottom:10px; transition:all .3s ease; }
        .condition-item:last-child{ border-bottom:none; }
        .task-button{ cursor:pointer; background: rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); }
        .task-button.completed{ background: rgba(0,255,136,0.2); border-color:#00ff88; cursor:default; }
        .task-button.task-ready{ background: rgba(0,255,136,0.1); border-color:#00ff88; animation: taskPulse 2s ease-in-out infinite; }
        @keyframes taskPulse { 0% { box-shadow: 0 0 10px rgba(0,255,136,0.3); } 50% { box-shadow: 0 0 20px rgba(0,255,136,0.6); } 100% { box-shadow: 0 0 10px rgba(0,255,136,0.3); } }

        .completed-tasks-section{ background:rgba(0,255,136,0.1); border:1px solid rgba(0,255,136,0.3); border-radius:15px; padding:20px; margin:20px 0; }
        .completed-task-item{ display:flex; justify-content:space-between; align-items:center; padding:12px; background:rgba(0,255,136,0.05); border-radius:8px; margin-bottom:8px; border:1px solid rgba(0,255,136,0.2); }

        .notification{ position:fixed; top:20px; right:20px; padding:15px 20px; border-radius:10px; font-weight:bold; z-index:1000; animation:slideIn .3s ease; }
        .notification.success{ background: rgba(0,255,136,0.2); border:1px solid #00ff88; color:#00ff88; }
        .notification.error{ background: rgba(255,107,53,0.2); border:1px solid #ff6b35; color:#ff6b35; }
        @keyframes slideIn{ from{ transform:translateX(100%); opacity:0 } to{ transform:translateX(0); opacity:1 } }

        .language-selector{ position:absolute; top:20px; right:20px; background:rgba(255,255,255,0.1); border-radius:20px; padding:8px 15px; cursor:pointer; transition:all .3s ease; }
        .language-selector:hover{ background:rgba(255,255,255,0.2); }

        .progress-bar{ background:rgba(255,255,255,0.1); border-radius:10px; height:8px; margin:10px 0; overflow:hidden; }
        .progress-fill{ height:100%; background:linear-gradient(90deg,#ff6b35,#f7931e); border-radius:10px; transition: width .3s ease; }

        @media (max-width:768px){ .header{ padding:10px 15px; flex-wrap:wrap; gap:10px; } .main-coin{ width:220px; height:220px; font-size:90px; } .coin-container{ width:220px; height:220px; margin:30px auto; } .balance-amount{ font-size:32px; } .stats-grid{ grid-template-columns:repeat(2,1fr); gap:10px; margin:20px 0; } .navigation-tabs{ gap:4px; margin-bottom:15px; } .nav-tab{ padding:8px 10px; font-size:11px; flex:1; min-width:0; } }

        /* small helper classes used below */
        .hidden{ display:none !important; }
        .center{ text-align:center; }
        pre{ white-space:pre-wrap; word-break:break-word; }
    </style>
</head>
<body>

    <!-- Firebase Status Indicator -->
    <div class="firebase-status firebase-disconnected" id="firebaseStatus">
        üîÑ Firebase ulanmoqda...
    </div>

    <!-- Language Selector -->
    <div class="language-selector" onclick="toggleLanguage()">
        <span class="country-flag" id="countryFlag">üá∫üáø</span>
        <span id="languageText">UZ</span>
    </div>

    <div class="header">
        <div class="user-info">
            <div class="avatar">üêâ</div>
            <div>
                <div style="font-weight: bold;" id="playerName">Dragon Miner</div>
                <div class="level-badge" id="levelBadge">Level 1</div>
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <div class="energy-bar">
                <span>‚ö°</span>
                <div class="energy-fill">
                    <div class="energy-progress" id="energyProgress" style="width:100%"></div>
                </div>
                <span id="energyText">1000/1000</span>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="navigation-tabs">
            <button class="nav-tab active" id="tapTab" onclick="showSection('tap')">üêâ <span data-translate="tap">Tapping</span></button>
            <button class="nav-tab" id="tasksTab" onclick="showSection('tasks')">üìã <span data-translate="tasks">Vazifalar</span></button>
            <button class="nav-tab" id="referralTab" onclick="showSection('referral')">üë• <span data-translate="referral">Referral</span></button>
            <button class="nav-tab" id="leaderboardTab" onclick="showSection('leaderboard')">üèÜ <span data-translate="leaderboard">Reyting</span></button>
            <button class="nav-tab" id="boostTab" onclick="showSection('boost')">‚ö° <span data-translate="boost">Boostlar</span></button>
            <button class="nav-tab" id="adminTab" onclick="showSection('admin')" style="display: none;">‚öôÔ∏è <span data-translate="admin">Admin</span></button>
            <button class="nav-tab" id="profileTab" onclick="showSection('profile')">üë§ <span data-translate="profile">Profil</span></button>
        </div>

        <div class="balance-display">
            <div class="balance-amount" id="balance">0</div>
            <div class="balance-label">Dragon Coins</div>
        </div>

        <!-- TAP SECTION -->
        <div class="section" id="tapSection">
            <div class="coin-container">
                <div class="main-coin" id="mainCoin"
                     onclick="tapCoin(event)"
                     ontouchstart="tapCoin(event)"
                     ontouchend="event.preventDefault()"
                     ontouchmove="event.preventDefault()">
                    <span style="font-size:120px; text-shadow:2px 2px 4px rgba(0,0,0,0.3); z-index:2; position:relative; pointer-events:none;">üêâ</span>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="tapPower">1</div>
                    <div class="stat-label" data-translate="coinsPerTap">Coins per tap</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalTaps">0</div>
                    <div class="stat-label" data-translate="totalTaps">Total taps</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="level">1</div>
                    <div class="stat-label" data-translate="level">Level</div>
                    <div class="stat-label" id="levelName" style="color:#00ff88; font-size:10px; margin-top:2px;">Wood</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="referralCount">0</div>
                    <div class="stat-label" data-translate="referrals">Referrals</div>
                </div>
            </div>

            <!-- Level Progress Bar -->
            <div style="background: rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 20px; margin: 20px 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div style="font-size: 16px; font-weight: bold;" id="currentLevelDisplay">Level 1 - Wood</div>
                    <div style="font-size: 14px; color: #ccc;" id="nextLevelDisplay">Next: Level 2 - Bronze</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="levelProgressBar" style="width: 0%;"></div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: #ccc; margin-top: 5px;">
                    <span id="currentTapsDisplay">0 taps</span>
                    <span id="requiredTapsDisplay">500 taps kerak</span>
                </div>
            </div>

            <div id="energyWarning" class="notification error" style="display: none; position: relative; top: auto; right: auto; margin: 20px 0;">
                <span data-translate="energyWarning">‚ö†Ô∏è Energy bo'sh! Energiya to'lishi uchun kutib turing.</span>
            </div>
        </div>

        <!-- TASKS SECTION -->
        <div class="section hidden" id="tasksSection">
            <div style="display:flex; gap:8px; margin-bottom:20px; justify-content:center; flex-wrap:wrap;">
                <button class="nav-tab active" id="basicTasksTab" onclick="showTaskCategory('basic')" style="padding:8px 12px; font-size:12px;">üìã <span data-translate="basicTasks">Asosiy Vazifalar</span></button>
                <button class="nav-tab" id="levelTasksTab" onclick="showTaskCategory('level')" style="padding:8px 12px; font-size:12px;">üèÜ <span data-translate="levelTasks">Level Vazifalari</span></button>
                <button class="nav-tab" id="referralTasksTab" onclick="showTaskCategory('referral')" style="padding:8px 12px; font-size:12px;">üë• <span data-translate="referralTasks">Referral Vazifalari</span></button>
                <button class="nav-tab" id="customTasksTab" onclick="showTaskCategory('custom')" style="padding:8px 12px; font-size:12px;">‚≠ê <span data-translate="customTasks">Maxsus Vazifalar</span></button>
                <button class="nav-tab" id="completedTasksTab" onclick="showTaskCategory('completed')" style="padding:8px 12px; font-size:12px;">‚úÖ <span data-translate="completedTasks">Bajarilgan</span> <span style="background: rgba(0,255,136,0.3); color:#00ff88; padding:2px 6px; border-radius:8px; font-size:10px; margin-left:4px;" id="completedTasksTabCount">0</span></button>
            </div>

            <div class="conditions-panel" id="basicTasksPanel">
                <h3 style="margin-bottom:15px; color:#ff6b35;">üìã <span data-translate="basicTasks">Asosiy Vazifalar</span></h3>
                <div id="basicTasksList"></div>
            </div>

            <div class="conditions-panel hidden" id="levelTasksPanel">
                <h3 style="margin-bottom:15px; color:#FFD700;">üèÜ <span data-translate="levelTasks">Level Vazifalari</span></h3>
                <div id="levelTasksList"></div>
            </div>

            <div class="conditions-panel hidden" id="referralTasksPanel">
                <h3 style="margin-bottom:15px; color:#8A2BE2;">üë• <span data-translate="referralTasks">Referral Vazifalari</span></h3>
                <div id="referralTasksList"></div>
            </div>

            <div class="conditions-panel hidden" id="customTasksPanel">
                <h3 style="margin-bottom:15px; color:#00ff88;">‚≠ê <span data-translate="customTasks">Maxsus Vazifalar</span></h3>
                <div id="customTasksList"></div>
            </div>

            <div class="conditions-panel hidden" id="completedTasksPanel">
                <h3 style="margin-bottom:15px; color:#00ff88; display:flex; align-items:center; gap:10px;"> ‚úÖ <span data-translate="completedTasks">Bajarilgan Vazifalar</span> <span style="background: rgba(0,255,136,0.2); color:#00ff88; padding:4px 8px; border-radius:12px; font-size:12px;" id="completedTasksCount">0</span></h3>
                <div id="completedTasksList"></div>
            </div>
        </div>

        <!-- REFERRAL SECTION -->
        <div class="section hidden" id="referralSection">
            <div class="conditions-panel">
                <h3 style="margin-bottom:15px; color:#ff6b35;">üë• <span data-translate="referralSystem">Referral Tizimi</span></h3>

                <div style="margin-bottom:20px;">
                    <h4 data-translate="yourReferralLink">Sizning referral linkingiz:</h4>
                    <div style="background: rgba(0,255,136,0.1); border:2px solid #00ff88; border-radius:10px; padding:15px; margin:15px 0; word-break:break-all; font-family:monospace; font-size:14px;" id="referralLink">
                        https://t.me/Dragon_coin_money_bot?start=ref_<span id="userReferralCode">123456</span>
                    </div>
                    <button style="background:#00ff88; color:#000; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:bold; margin:10px 0; transition:all .3s ease;" onclick="copyReferralLink()">
                        üìã <span data-translate="copyLink">Linkni nusxalash</span>
                    </button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalReferrals">0</div>
                        <div class="stat-label" data-translate="totalReferrals">Jami referrallar</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="referralEarnings">0</div>
                        <div class="stat-label" data-translate="referralEarnings">Referral daromadi</div>
                    </div>
                </div>

                <div style="background: rgba(0,255,136,0.1); border-radius:10px; padding:15px; margin:20px 0;">
                    <h4 data-translate="referralRewards">Referral mukofotlari:</h4>
                    <ul style="margin:10px 0; padding-left:20px;">
                        <li data-translate="reward1">Har bir referral uchun: +500 DRC</li>
                        <li data-translate="reward2">Referral birinchi marta tap qilganda: +200 DRC</li>
                        <li data-translate="reward3">Referral Level 5 ga yetganda: +1000 DRC</li>
                        <li data-translate="reward4">Referral 10000 coin to'plaganda: +2000 DRC</li>
                    </ul>
                </div>

                <h4 data-translate="yourReferrals">Sizning referrallaringiz:</h4>
                <div id="referralList">
                    <div style="text-align:center; color:#ccc; padding:20px;" data-translate="noReferrals">Hali referrallaringiz yo'q. Do'stlaringizni taklif qiling!</div>
                </div>
            </div>
        </div>

        <!-- BOOST SECTION -->
        <div class="section hidden" id="boostSection">
            <div class="conditions-panel">
                <h3 style="margin-bottom:15px; color:#ff6b35;">‚ö° <span data-translate="boost">Boostlar</span></h3>

                <div style="background: rgba(0,255,136,0.1); border-radius:15px; padding:20px; margin-bottom:20px;">
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; text-align:center;">
                        <div>
                            <div style="font-size:24px; font-weight:bold; color:#00ff88;" id="currentTapPower">1</div>
                            <div style="font-size:12px; color:#ccc;" data-translate="tapPower">Tap Power</div>
                        </div>
                        <div>
                            <div style="font-size:24px; font-weight:bold; color:#ff6b35;" id="currentMaxEnergy">1000</div>
                            <div style="font-size:12px; color:#ccc;" data-translate="maxEnergy">Max Energy</div>
                        </div>
                        <div>
                            <div style="font-size:24px; font-weight:bold; color:#FFD700;" id="currentMultitap">1</div>
                            <div style="font-size:12px; color:#ccc;" data-translate="multitap">Multitap</div>
                        </div>
                    </div>
                </div>

                <div style="background: rgba(255,255,255,0.05); border-radius:15px; padding:20px; margin:20px 0;">
                    <h4 style="color:#00ff88; margin-bottom:15px;">üëÜ <span data-translate="tapPowerBoosts">Tap Power</span></h4>
                    <div class="condition-item task-button" onclick="buyCurrentTapPowerBoost()" id="tapPowerBoostCurrent">
                        <div class="condition-text">
                            <div style="font-weight:bold;">üëÜ Tap Power +1</div>
                            <div style="font-size:12px; color:#ccc;">Har bir sarmoya uchun +1 tap power</div>
                        </div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div class="condition-reward">500 DRC</div>
                            <div class="condition-status condition-pending" id="tapPowerStatus"></div>
                        </div>
                    </div>
                </div>

                <div style="background: rgba(255,255,255,0.05); border-radius:15px; padding:20px; margin:20px 0;">
                    <h4 style="color:#ff6b35; margin-bottom:15px;">üîã <span data-translate="energyBoosts">Energy Limit</span></h4>
                    <div class="condition-item task-button" onclick="buyCurrentEnergyBoost()" id="energyBoostCurrent">
                        <div class="condition-text">
                            <div style="font-weight:bold;">üîã Max Energy +200</div>
                            <div style="font-size:12px; color:#ccc;">Energiya limitini oshirish</div>
                        </div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div class="condition-reward">1000 DRC</div>
                            <div class="condition-status condition-pending" id="energyBoostStatus"></div>
                        </div>
                    </div>
                </div>

                <div style="background: rgba(255,255,255,0.05); border-radius:15px; padding:20px; margin:20px 0;">
                    <h4 style="color:#FFD700; margin-bottom:15px;">üëÜ <span data-translate="multitapBoosts">Multitap</span></h4>
                    <div class="condition-item task-button" onclick="buyCurrentMultitapBoost()" id="multitapBoostCurrent">
                        <div class="condition-text">
                            <div style="font-weight:bold;">‚ú¥Ô∏è Multitap +1</div>
                            <div style="font-size:12px; color:#ccc;">Ko'p bosish imkoniyati</div>
                        </div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div class="condition-reward">1500 DRC</div>
                            <div class="condition-status condition-pending" id="multitapStatus"></div>
                        </div>
                    </div>
                </div>

                <div style="background: rgba(255,215,0,0.1); border:1px solid rgba(255,215,0,0.3); border-radius:15px; padding:20px; margin:20px 0;">
                    <h4 style="color:#FFD700; margin-bottom:15px;">üåü <span data-translate="specialBoosts">Special Boosts</span></h4>

                    <div class="condition-item task-button" onclick="buyBoost('energyRefill', 1, 500)" id="energyRefillBoost">
                        <div class="condition-text">
                            <div style="font-weight:bold;">‚ö° Full Energy</div>
                            <div style="font-size:12px; color:#ccc;">Instantly refill energy</div>
                        </div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div class="condition-reward">500 DRC</div>
                            <div class="condition-status condition-pending" id="energyRefillStatus"></div>
                        </div>
                    </div>

                    <div class="condition-item task-button" onclick="buyBoost('turbo', 1, 2500)" id="turboBoost">
                        <div class="condition-text">
                            <div style="font-weight:bold;">üöÄ Turbo (20 seconds)</div>
                            <div style="font-size:12px; color:#ccc;">Unlimited energy for 20 seconds</div>
                        </div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div class="condition-reward">2,500 DRC</div>
                            <div class="condition-status condition-pending" id="turboStatus"></div>
                        </div>
                    </div>
                </div>

                <div id="activeBoostsSection" style="background: rgba(0,255,136,0.1); border:1px solid rgba(0,255,136,0.3); border-radius:15px; padding:20px; margin:20px 0; display:none;">
                    <h4 style="color:#00ff88; margin-bottom:15px;">üî• <span data-translate="activeBoosts">Active Boosts</span></h4>
                    <div id="activeBoostsList"></div>
                </div>
            </div>
        </div>

        <!-- LEADERBOARD SECTION -->
        <div class="section hidden" id="leaderboardSection">
            <div class="conditions-panel">
                <h3 style="margin-bottom:15px; color:#ff6b35;">üèÜ <span data-translate="leaderboard">Reyting Jadvali</span></h3>

                <div style="display:flex; gap:10px; margin-bottom:20px; justify-content:center;">
                    <button class="nav-tab active" id="coinsLeaderboardBtn" onclick="showLeaderboard('coins')" style="padding:8px 16px;">üí∞ <span data-translate="byCoins">Coinlar bo'yicha</span></button>
                    <button class="nav-tab" id="referralsLeaderboardBtn" onclick="showLeaderboard('referrals')" style="padding:8px 16px;">üë• <span data-translate="byReferrals">Referrallar bo'yicha</span></button>
                </div>

                <div style="background: rgba(0,255,136,0.1); border-radius:10px; padding:15px; margin-bottom:20px; text-align:center;">
                    <div style="font-size:18px; font-weight:bold; color:#00ff88;" data-translate="yourRank">Sizning o'rningiz:</div>
                    <div style="font-size:24px; font-weight:bold; margin-top:5px;" id="playerRank">#-</div>
                </div>

                <div id="leaderboardList"></div>
            </div>
        </div>

        <!-- PLAYER PROFILE MODAL (kept original) -->
        <div id="playerProfileModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; backdrop-filter: blur(10px);">
            <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background: rgba(10,10,15,0.95); border-radius:20px; padding:30px; max-width:400px; width:90%; border:2px solid rgba(0,255,136,0.3);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="color:#00ff88; margin:0;">üë§ <span data-translate="playerProfile">O'yinchi Profili</span></h3>
                    <button onclick="closePlayerModal()" style="background:none; border:none; color:#ff6b35; font-size:24px; cursor:pointer;">√ó</button>
                </div>
                <div style="text-align:center; margin-bottom:25px;">
                    <div style="width:80px; height:80px; background:linear-gradient(45deg,#ff6b35,#f7931e); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:40px; margin:0 auto 15px;">üêâ</div>
                    <h2 style="color:#00ff88; margin-bottom:5px;" id="modalPlayerName">Player Name</h2>
                    <div style="color:#ccc; font-size:14px;" id="modalPlayerCountry">üá∫üáø UZ</div>
                    <div style="color:#ccc; font-size:12px; margin-top:5px;" id="modalPlayerStatus">üü¢ Online</div>
                </div>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px;">
                    <div style="text-align:center; padding:15px; background: rgba(0,255,136,0.1); border-radius:10px;">
                        <div style="font-size:20px; font-weight:bold; color:#00ff88;" id="modalPlayerBalance">0</div>
                        <div style="font-size:12px; color:#ccc;">Dragon Coins</div>
                    </div>
                    <div style="text-align:center; padding:15px; background: rgba(255,107,53,0.1); border-radius:10px;">
                        <div style="font-size:20px; font-weight:bold; color:#ff6b35;" id="modalPlayerLevel">1</div>
                        <div style="font-size:12px; color:#ccc;" data-translate="level">Level</div>
                        <div style="font-size:10px; color:#ff6b35; margin-top:2px;" id="modalPlayerLevelName">Wood</div>
                    </div>
                    <div style="text-align:center; padding:15px; background: rgba(255,215,0,0.1); border-radius:10px;">
                        <div style="font-size:20px; font-weight:bold; color:#FFD700;" id="modalPlayerTaps">0</div>
                        <div style="font-size:12px; color:#ccc;" data-translate="totalTaps">Total Taps</div>
                    </div>
                    <div style="text-align:center; padding:15px; background: rgba(138,43,226,0.1); border-radius:10px;">
                        <div style="font-size:20px; font-weight:bold; color:#8A2BE2;" id="modalPlayerReferrals">0</div>
                        <div style="font-size:12px; color:#ccc;" data-translate="referrals">Referrals</div>
                    </div>
                </div>

                <div style="background: rgba(255,255,255,0.05); border-radius:10px; padding:15px; margin-bottom:20px;">
                    <h4 style="color:#00ff88; margin-bottom:10px; font-size:14px;">üìä <span data-translate="playerStats">O'yinchi Statistikasi</span></h4>
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <span style="color:#ccc; font-size:12px;" data-translate="rankPosition">Reyting pozitsiyasi:</span>
                        <span style="color:#00ff88; font-weight:bold; font-size:12px;" id="modalPlayerRank">#1</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <span style="color:#ccc; font-size:12px;" data-translate="lastSeen">Oxirgi faollik:</span>
                        <span style="color:#ccc; font-size:12px;" id="modalPlayerLastSeen">Hozir</span>
                    </div>
                    <div style="display:flex; justify-content:space-between;">
                        <span style="color:#ccc; font-size:12px;" data-translate="playerType">O'yinchi turi:</span>
                        <span style="color:#00ff88; font-size:12px;" id="modalPlayerType">Real Player</span>
                    </div>
                </div>

                <div style="display:flex; gap:10px;">
                    <button onclick="closePlayerModal()" style="flex:1; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.3); color:#fff; padding:12px; border-radius:8px; cursor:pointer; font-weight:bold;"> <span data-translate="close">Yopish</span> </button>
                    <button onclick="challengePlayer()" style="flex:1; background:linear-gradient(45deg,#00ff88,#00cc6a); border:none; color:#000; padding:12px; border-radius:8px; cursor:pointer; font-weight:bold;"> <span data-translate="challenge">Raqobat</span> </button>
                </div>
            </div>
        </div>

        <!-- ADMIN SECTION -->
        <div class="section hidden" id="adminSection">
            <div class="conditions-panel">
                <h3 style="margin-bottom:15px; color:#ff6b35;">‚öôÔ∏è <span data-translate="admin">Admin Panel</span></h3>

                <div style="background: rgba(255,107,53,0.1); border:1px solid rgba(255,107,53,0.3); border-radius:15px; padding:20px; margin:20px 0;">
                    <h4 style="color:#ff6b35; margin-bottom:15px;">üë• <span data-translate="playerManagement">O'yinchi Boshqaruvi</span></h4>

                    <div class="condition-item" style="margin-bottom:10px;">
                        <div>
                            <div style="font-weight:bold;" data-translate="totalPlayers">Jami o'yinchilar</div>
                            <div style="font-size:12px; color:#ccc;" data-translate="registeredUsers">Ro'yxatdan o'tgan foydalanuvchilar</div>
                        </div>
                        <div style="color:#ff6b35; font-weight:bold;" id="totalPlayersCount">0</div>
                    </div>

                    <div class="condition-item" style="margin-bottom:10px;">
                        <div>
                            <div style="font-weight:bold;" data-translate="onlinePlayers">Online o'yinchilar</div>
                            <div style="font-size:12px; color:#ccc;" data-translate="currentlyActive">Hozir faol</div>
                        </div>
                        <div style="color:#00ff88; font-weight:bold;" id="onlinePlayersCount">0</div>
                    </div>

                    <div class="condition-item">
                        <div>
                            <div style="font-weight:bold;" data-translate="totalCoins">Jami coinlar</div>
                            <div style="font-size:12px; color:#ccc;" data-translate="systemWide">Tizim bo'ylab</div>
                        </div>
                        <div style="color:#FFD700; font-weight:bold;" id="totalCoinsCount">0</div>
                    </div>
                </div>

                <div style="background: rgba(0,255,136,0.1); border:1px solid rgba(0,255,136,0.3); border-radius:15px; padding:20px; margin:20px 0;">
                    <h4 style="color:#00ff88; margin-bottom:15px;">üéÆ <span data-translate="systemControls">Tizim Boshqaruvi</span></h4>

                    <div class="condition-item task-button" onclick="adminAction('addCoins')" style="margin-bottom:10px;">
                        <div class="condition-text">
                            <div style="font-weight:bold;" data-translate="addCoinsToPlayer">O'yinchiga coin qo'shish</div>
                            <div style="font-size:12px; color:#ccc;" data-translate="addCoinsDesc">Tanlangan o'yinchiga coin berish</div>
                        </div>
                        <div style="color:#00ff88; font-weight:bold;">üí∞</div>
                    </div>

                    <div class="condition-item task-button" onclick="adminAction('resetPlayer')" style="margin-bottom:10px;">
                        <div class="condition-text">
                            <div style="font-weight:bold;" data-translate="resetPlayer">O'yinchini qayta boshlash</div>
                            <div style="font-size:12px; color:#ccc;" data-translate="resetPlayerDesc">O'yinchi ma'lumotlarini tozalash</div>
                        </div>
                        <div style="color:#ff6b35; font-weight:bold;">üîÑ</div>
                    </div>

                    <div class="condition-item task-button" onclick="adminAction('broadcastMessage')" style="margin-bottom:10px;">
                        <div class="condition-text">
                            <div style="font-weight:bold;" data-translate="broadcastMessage">Umumiy xabar</div>
                            <div style="font-size:12px; color:#ccc;" data-translate="broadcastDesc">Barcha o'yinchilarga xabar yuborish</div>
                        </div>
                        <div style="color:#8A2BE2; font-weight:bold;">üì¢</div>
                    </div>

                    <div class="condition-item task-button" onclick="adminAction('systemMaintenance')">
                        <div class="condition-text">
                            <div style="font-weight:bold;" data-translate="systemMaintenance">Tizim texnik xizmati</div>
                            <div style="font-size:12px; color:#ccc;" data-translate="maintenanceDesc">Tizimni texnik xizmatga o'tkazish</div>
                        </div>
                        <div style="color:#ff6b35; font-weight:bold;">üîß</div>
                    </div>
                </div>

                <div style="background: rgba(255,215,0,0.1); border:1px solid rgba(255,215,0,0.3); border-radius:15px; padding:20px; margin:20px 0;">
                    <h4 style="color:#FFD700; margin-bottom:15px;">üìã <span data-translate="taskManagement">Vazifa Boshqaruvi</span></h4>

                    <div class="condition-item task-button" onclick="adminAction('addTask')" style="margin-bottom:10px;">
                        <div class="condition-text">
                            <div style="font-weight:bold;" data-translate="addNewTask">Yangi vazifa qo'shish</div>
                            <div style="font-size:12px; color:#ccc;" data-translate="addTaskDesc">Tizimga yangi vazifa qo'shish</div>
                        </div>
                        <div style="color:#FFD700; font-weight:bold;">‚ûï</div>
                    </div>

                    <div class="condition-item task-button" onclick="adminAction('removeTask')" style="margin-bottom:10px;">
                        <div class="condition-text">
                            <div style="font-weight:bold;" data-translate="removeTask">Vazifani o'chirish</div>
                            <div style="font-size:12px; color:#ccc;" data-translate="removeTaskDesc">Mavjud vazifani o'chirish</div>
                        </div>
                        <div style="color:#ff6b35; font-weight:bold;">‚ûñ</div>
                    </div>

                    <div class="condition-item task-button" onclick="adminAction('editTask')" style="margin-bottom:10px;">
                        <div class="condition-text">
                            <div style="font-weight:bold;" data-translate="editTask">Vazifani tahrirlash</div>
                            <div style="font-size:12px; color:#ccc;" data-translate="editTaskDesc">Mavjud vazifa ma'lumotlarini o'zgartirish</div>
                        </div>
                        <div style="color:#00ff88; font-weight:bold;">‚úèÔ∏è</div>
                    </div>

                    <div class="condition-item task-button" onclick="adminAction('viewTasks')">
                        <div class="condition-text">
                            <div style="font-weight:bold;" data-translate="viewAllTasks">Barcha vazifalarni ko'rish</div>
                            <div style="font-size:12px; color:#ccc;" data-translate="viewTasksDesc">Tizimda mavjud barcha vazifalar</div>
                        </div>
                        <div style="color:#8A2BE2; font-weight:bold;">üëÅÔ∏è</div>
                    </div>
                </div>

                <div style="background: rgba(255,215,0,0.1); border:1px solid rgba(255,215,0,0.3); border-radius:15px; padding:20px; margin:20px 0;">
                    <h4 style="color:#FFD700; margin-bottom:15px;">üìä <span data-translate="gameStatistics">O'yin Statistikasi</span></h4>

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                        <div style="text-align:center; padding:15px; background: rgba(255,215,0,0.1); border-radius:10px;">
                            <div style="font-size:24px; font-weight:bold; color:#FFD700;" id="totalTapsSystem">0</div>
                            <div style="font-size:12px; color:#ccc;" data-translate="totalTapsSystem">Jami taplar</div>
                        </div>
                        <div style="text-align:center; padding:15px; background: rgba(138,43,226,0.1); border-radius:10px;">
                            <div style="font-size:24px; font-weight:bold; color:#8A2BE2;" id="totalReferralsSystem">0</div>
                            <div style="font-size:12px; color:#ccc;" data-translate="totalReferralsSystem">Jami referrallar</div>
                        </div>
                        <div style="text-align:center; padding:15px; background: rgba(0,255,136,0.1); border-radius:10px;">
                            <div style="font-size:24px; font-weight:bold; color:#00ff88;" id="completedTasksSystem">0</div>
                            <div style="font-size:12px; color:#ccc;" data-translate="completedTasksSystem">Bajarilgan vazifalar</div>
                        </div>
                        <div style="text-align:center; padding:15px; background: rgba(255,107,53,0.1); border-radius:10px;">
                            <div style="font-size:24px; font-weight:bold; color:#ff6b35;" id="activeBoostsSystem">0</div>
                            <div style="font-size:12px; color:#ccc;" data-translate="activeBoostsSystem">Faol boostlar</div>
                        </div>
                    </div>
                </div>

                <div style="background: rgba(255,255,255,0.05); border-radius:15px; padding:20px; margin:20px 0;">
                    <h4 style="color:#00ff88; margin-bottom:15px;">üìà <span data-translate="recentActivity">So'nggi Faollik</span></h4>
                    <div id="recentActivityList"></div>
                </div>
            </div>
        </div>

        <!-- PROFILE SECTION -->
        <div class="section hidden" id="profileSection">
            <div class="conditions-panel">
                <h3 style="margin-bottom:15px; color:#ff6b35;">üë§ <span data-translate="profile">Foydalanuvchi Profili</span></h3>

                <div style="text-align:center; margin-bottom:30px;">
                    <div style="width:100px; height:100px; background:linear-gradient(45deg,#ff6b35,#f7931e); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:50px; margin:0 auto 15px;">üêâ</div>
                    <h2 style="color:#00ff88; margin-bottom:5px;" id="profilePlayerName">Dragon Miner</h2>
                    <div style="color:#ccc; font-size:14px;" id="profilePlayerId">ID: loading...</div>
                    <div style="color:#ccc; font-size:14px; margin-top:5px;">
                        <span data-translate="joinedDate">Qo'shilgan sana:</span> <span id="profileJoinDate">2024</span>
                    </div>
                </div>

                <div class="stats-grid" style="margin-bottom:30px;">
                    <div class="stat-card">
                        <div class="stat-value" id="profileBalance">0</div>
                        <div class="stat-label">Dragon Coins</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="profileLevel">1</div>
                        <div class="stat-label" data-translate="level">Level</div>
                        <div class="stat-label" id="profileLevelName" style="color:#00ff88; font-size:10px; margin-top:2px;">Wood</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="profileTotalTaps">0</div>
                        <div class="stat-label" data-translate="totalTaps">Jami taplar</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="profileReferrals">0</div>
                        <div class="stat-label" data-translate="referrals">Referrallar</div>
                    </div>
                </div>

                <div style="background: rgba(255,215,0,0.1); border:1px solid rgba(255,215,0,0.3); border-radius:15px; padding:20px; margin:20px 0;">
                    <h4 style="color:#FFD700; margin-bottom:15px; display:flex; align-items:center; gap:10px;"> üèÜ <span data-translate="achievements">Yutuqlar</span> <span style="background: rgba(255,215,0,0.2); color:#FFD700; padding:4px 8px; border-radius:12px; font-size:12px;" id="achievementsCount">0</span></h4>
                    <div id="achievementsList"></div>
                </div>

                <div style="background: rgba(255,255,255,0.05); border-radius:15px; padding:20px; margin:20px 0;">
                    <h4 style="color:#00ff88; margin-bottom:15px;">üìä <span data-translate="gameStats">O'yin Statistikasi</span></h4>

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                        <div style="text-align:center; padding:15px; background: rgba(0,255,136,0.1); border-radius:10px;">
                            <div style="font-size:24px; font-weight:bold; color:#00ff88;" id="profileTapPower">1</div>
                            <div style="font-size:12px; color:#ccc;" data-translate="tapPower">Tap kuchi</div>
                        </div>
                        <div style="text-align:center; padding:15px; background: rgba(255,107,53,0.1); border-radius:10px;">
                            <div style="font-size:24px; font-weight:bold; color:#ff6b35;" id="profileEnergy">1000</div>
                            <div style="font-size:12px; color:#ccc;" data-translate="currentEnergy">Hozirgi energiya</div>
                        </div>
                        <div style="text-align:center; padding:15px; background: rgba(255,215,0,0.1); border-radius:10px;">
                            <div style="font-size:24px; font-weight:bold; color:#FFD700;" id="profileCompletedTasks">0</div>
                            <div style="font-size:12px; color:#ccc;" data-translate="completedTasksCount">Bajarilgan vazifalar</div>
                        </div>
                        <div style="text-align:center; padding:15px; background: rgba(138,43,226,0.1); border-radius:10px;">
                            <div style="font-size:24px; font-weight:bold; color:#8A2BE2;" id="profileReferralEarnings">0</div>
                            <div style="font-size:12px; color:#ccc;" data-translate="referralEarnings">Referral daromadi</div>
                        </div>
                    </div>
                </div>

                <div style="background: rgba(255,255,255,0.05); border-radius:15px; padding:20px; margin:20px 0;">
                    <h4 style="color:#00ff88; margin-bottom:15px;">‚öôÔ∏è <span data-translate="settings">Sozlamalar</span></h4>

                    <div class="condition-item" style="margin-bottom:10px;">
                        <div><div style="font-weight:bold;" data-translate="language">Til</div><div style="font-size:12px; color:#ccc;" data-translate="currentLanguage">Hozirgi til</div></div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span id="currentLanguageDisplay">üá∫üáø UZ</span>
                            <button onclick="toggleLanguage()" style="background:#00ff88; color:#000; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:12px;"> <span data-translate="change">O'zgartirish</span> </button>
                        </div>
                    </div>

                    <div class="condition-item" style="margin-bottom:10px;">
                        <div><div style="font-weight:bold;" data-translate="dataStorage">Ma'lumotlar saqlash</div><div style="font-size:12px; color:#ccc;" data-translate="localStorage">Mahalliy xotira</div></div>
                        <div style="color:#00ff88; font-weight:bold;"><span data-translate="active">Faol</span></div>
                    </div>
                </div>
            </div>
        </div>

    </div> <!-- end main-container -->

    <script type="module">
        // ====== Firebase init (kept from your original file) ======
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
        import { getDatabase, ref, set, get, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDShZAo9lg-SxpQViCT27uXVni1UK7TGYU",
            authDomain: "dragon-92897.firebaseapp.com",
            databaseURL: "https://dragon-92897-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "dragon-92897",
            storageBucket: "dragon-92897.firebasestorage.app",
            messagingSenderId: "40351345340",
            appId: "1:40351345340:web:632388a9b45d3c7905feb9",
            measurementId: "G-FXT1F3NPCD"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);
        const auth = getAuth(app);

        // anonymous sign-in (from your original)
        signInAnonymously(auth)
            .then(()=> console.log("‚úÖ Anonymous login yuborildi"))
            .catch((e)=> console.error("‚ùå Login xatosi:", e));

        // when auth ready, create player node if missing (kept from original)
        onAuthStateChanged(auth, (user)=>{
            if(user){
                console.log("üë§ Auth UID:", user.uid);
                window.firebaseApp = app;
                window.firebaseDatabase = database;
                window.firebaseRef = ref;
                window.firebaseSet = set;
                window.firebaseGet = get;
                window.firebaseOnValue = onValue;
                window.firebasePush = push;
                window.firebaseUpdate = update;
                window.firebaseRemove = remove;
                window.firebaseAuthUid = user.uid;

                const playerRef = ref(database, "players/" + user.uid);
                set(playerRef, { name: "Dragon Miner", coins: 0, level: 1, referrals: 0 })
                    .then(()=> console.log("‚úÖ Player ma'lumotlari yozildi"))
                    .catch((err)=> console.error("‚ùå Player yozishda xato:", err));

                // update firebase status UI
                const fs = document.getElementById('firebaseStatus');
                if(fs) { fs.classList.remove('firebase-disconnected'); fs.classList.add('firebase-connected'); fs.textContent = "‚úÖ Firebase ulandi"; }
            }
        });

        // ====== Helper UI functions (these were missing) ======
        function clearNavActive() {
            document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
        }

        // showSection toggles main sections without touching HTML structure
        window.showSection = function(section) {
            // map ids used in HTML to section wrappers
            const mapping = {
                'tap': 'tapSection',
                'tasks': 'tasksSection',
                'referral': 'referralSection',
                'leaderboard': 'leaderboardSection',
                'boost': 'boostSection',
                'admin': 'adminSection',
                'profile': 'profileSection'
            };
            // hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            // set active nav-tab
            clearNavActive();
            // attempt match nav tab by id (like tapTab)
            const navId = {
                'tap': 'tapTab',
                'tasks':'tasksTab','referral':'referralTab','leaderboard':'leaderboardTab','boost':'boostTab','admin':'adminTab','profile':'profileTab'
            }[section];
            if(navId) {
                const navBtn = document.getElementById(navId);
                if(navBtn) navBtn.classList.add('active');
            }
            // show mapped section
            const secId = mapping[section];
            if(secId) {
                const el = document.getElementById(secId);
                if(el) el.classList.remove('hidden');
            }
            // extra: if switching to leaderboard, load by coins default
            if(section === 'leaderboard') loadLeaderboard('coins');
        };

        // task category switcher (for tasks page)
        window.showTaskCategory = function(cat) {
            const panels = ['basic','level','referral','custom','completed'];
            panels.forEach(p=>{
                const panelEl = document.getElementById(p + 'TasksPanel') || document.getElementById(p + 'TasksPanel'.toLowerCase());
                // fallback: actual ids in HTML are basicTasksPanel, levelTasksPanel, etc.
                const realEl = document.getElementById(p + 'TasksPanel') || document.getElementById(p + 'TasksPanel'.replace('TasksPanel', 'sPanel'));
            });
            // simple implementation consistent with HTML ids:
            document.getElementById('basicTasksPanel').classList.toggle('hidden', cat !== 'basic');
            document.getElementById('levelTasksPanel').classList.toggle('hidden', cat !== 'level');
            document.getElementById('referralTasksPanel').classList.toggle('hidden', cat !== 'referral');
            document.getElementById('customTasksPanel').classList.toggle('hidden', cat !== 'custom');
            document.getElementById('completedTasksPanel').classList.toggle('hidden', cat !== 'completed');
            // nav buttons active state
            ['basicTasksTab','levelTasksTab','referralTasksTab','customTasksTab','completedTasksTab'].forEach(id=>{
                const b = document.getElementById(id);
                if(b) b.classList.remove('active');
            });
            const activeBtn = {'basic':'basicTasksTab','level':'levelTasksTab','referral':'referralTasksTab','custom':'customTasksTab','completed':'completedTasksTab'}[cat];
            if(activeBtn) document.getElementById(activeBtn).classList.add('active');
        };

        // copy referral link to clipboard
        window.copyReferralLink = function(){
            const el = document.getElementById('referralLink');
            if(!el) return alert("Link topilmadi");
            const text = el.innerText || el.textContent;
            navigator.clipboard?.writeText(text.trim()).then(()=> {
                alert("‚úÖ Referral link nusxalandi");
            }).catch(()=> {
                // fallback: select
                const ta = document.createElement('textarea');
                ta.value = text.trim();
                document.body.appendChild(ta);
                ta.select();
                try { document.execCommand('copy'); alert("‚úÖ Referral link nusxalandi"); } catch(e){ alert("‚ùå Nusxalash xato"); }
                ta.remove();
            });
        };

        // ====== Leaderboard: load and render (fixes reyting muammosini) ======
        window.loadLeaderboard = function(type = 'coins') {
            const playersRef = ref(database, "players");
            get(playersRef).then(snapshot=>{
                const listEl = document.getElementById('leaderboardList');
                if(!listEl) return;
                if(snapshot.exists()){
                    const data = snapshot.val();
                    // convert to array with uid
                    const arr = Object.keys(data).map(k => ({ uid:k, ...(data[k]||{}) }));
                    if(type === 'coins'){
                        arr.sort((a,b) => (b.coins||0) - (a.coins||0));
                    } else if(type === 'referrals') {
                        arr.sort((a,b) => (b.referrals||0) - (a.referrals||0));
                    }
                    listEl.innerHTML = arr.map((p,i)=> {
                        const coins = p.coins || 0;
                        const refs = p.referrals || 0;
                        return `<div style="padding:6px; border-bottom:1px solid #333;">#${i+1} ‚Äî <strong>${escapeHtml(p.name||p.uid)}</strong> ‚Äî ${type==='coins'? coins + ' DRC' : refs + ' refs' }</div>`;
                    }).join('');
                    // try to find current user's rank
                    const meUid = window.firebaseAuthUid;
                    if(meUid){
                        const myIndex = arr.findIndex(x=>x.uid === meUid);
                        const pr = document.getElementById('playerRank');
                        if(pr) pr.textContent = myIndex>=0 ? `#${myIndex+1}` : '#-';
                    }
                } else {
                    listEl.innerHTML = `<div style="padding:10px; color:#ccc;">Hech qanday o'yinchi topilmadi</div>`;
                }
            }).catch(err=>{
                console.error("Leaderboard error:", err);
                const listEl = document.getElementById('leaderboardList');
                if(listEl) listEl.innerHTML = `<div style="padding:10px; color:#ff6b35;">Yuklashda xato</div>`;
            });
        };

        // small escape to avoid injection in leaderboard rendering
        function escapeHtml(s){
            return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
        }

        // convenience wrapper (used by buttons)
        window.showLeaderboard = function(type){
            // mark active
            document.getElementById('coinsLeaderboardBtn')?.classList.toggle('active', type==='coins');
            document.getElementById('referralsLeaderboardBtn')?.classList.toggle('active', type==='referrals');
            loadLeaderboard(type);
        };

        // ====== Admin actions (fixes admin panel not responding) ======
        window.adminAction = function(action){
            const db = database;
            switch(action){
                case 'addCoins': {
                    const targetId = prompt("O'yinchi UID kiriting:");
                    if(!targetId) return;
                    const amount = parseInt(prompt("Nechta coin qo'shilsin?"), 10);
                    if(isNaN(amount)) return alert("Noto'g'ri son");
                    const playerRef = ref(db, "players/" + targetId);
                    get(playerRef).then(snap=>{
                        if(snap.exists()){
                            const data = snap.val();
                            const newCoins = (data.coins||0) + amount;
                            update(playerRef, { coins: newCoins }).then(()=> alert("üí∞ " + amount + " coin qo'shildi!")).catch(e=> alert("‚ùå Xatolik: "+ e.message));
                        } else alert("‚ùå O'yinchi topilmadi!");
                    }).catch(e=> alert("‚ùå Xatolik: "+ e.message));
                    break;
                }
                case 'resetPlayer': {
                    const resetId = prompt("O'yinchi UID kiriting:");
                    if(!resetId) return;
                    const resetRef = ref(db, "players/" + resetId);
                    set(resetRef, { name: "Dragon Miner", coins: 0, level: 1, referrals: 0 }).then(()=> alert("üîÑ O'yinchi qayta tiklandi!")).catch(e=> alert("‚ùå Xatolik: "+ e.message));
                    break;
                }
                case 'broadcastMessage': {
                    const msg = prompt("Xabar matnini kiriting:");
                    if(msg) {
                        // you can implement real broadcast via cloud functions later
                        alert("üì¢ (Demo) Xabar yuboriladi: " + msg);
                    }
                    break;
                }
                case 'systemMaintenance': {
                    alert("üîß Tizim texnik xizmat rejimida (demo flag)");
                    break;
                }
                case 'addTask': {
                    const taskName = prompt("Yangi vazifa nomi:");
                    if(!taskName) return;
                    const tasksRef = ref(db, "globalCustomTasks");
                    push(tasksRef, { name: taskName, reward: 100 }).then(()=> alert("‚ûï Vazifa qo'shildi!")).catch(e=> alert("‚ùå Xatolik: "+ e.message));
                    break;
                }
                case 'removeTask': {
                    const key = prompt("O'chirish uchun vazifa kalitini kiriting (task key):");
                    if(!key) return;
                    const itemRef = ref(db, "globalCustomTasks/" + key);
                    remove(itemRef).then(()=> alert("‚ûñ Vazifa o'chirildi")).catch(e=> alert("‚ùå Xatolik: "+ e.message));
                    break;
                }
                case 'editTask': {
                    const key = prompt("Tahrirlash uchun vazifa kalitini kiriting (task key):");
                    if(!key) return;
                    const newName = prompt("Yangi nomni kiriting:");
                    if(!newName) return;
                    const itemRef = ref(db, "globalCustomTasks/" + key);
                    update(itemRef, { name: newName }).then(()=> alert("‚úèÔ∏è Vazifa yangilandi")).catch(e=> alert("‚ùå Xatolik: "+ e.message));
                    break;
                }
                case 'viewTasks': {
                    const tasksRef = ref(db, "globalCustomTasks");
                    get(tasksRef).then(snap=>{
                        if(snap.exists()){
                            console.log("üìã Vazifalar:", snap.val());
                            alert("üëÅÔ∏è Vazifalar konsolda ko'rsatildi (F12 bilan tekshiring)");
                        } else alert("‚ùå Vazifalar topilmadi");
                    }).catch(e=> alert("‚ùå Xatolik: "+ e.message));
                    break;
                }
                default:
                    alert("‚ö†Ô∏è Noma'lum action: " + action);
            }
        };

        // ====== Small shop/boost functions (minimal, non-breaking) ======
        window.buyBoost = function(id, qty, price){
            const confirmBuy = confirm(`Buy ${id} for ${price} DRC?`);
            if(!confirmBuy) return;
            // demo: subtract from current balance if we have profileBalance element
            const balEl = document.getElementById('balance');
            let bal = parseInt(balEl?.textContent || "0", 10) || 0;
            if(bal < price) return alert("‚ùå Yetarli coin yo'q");
            bal -= price;
            if(balEl) balEl.textContent = bal;
            alert("‚úÖ Boost sotib olindi");
        };
        window.buyCurrentTapPowerBoost = function(){ buyBoost('tapPower',1,500); };
        window.buyCurrentEnergyBoost = function(){ buyBoost('energyLimit',1,1000); };
        window.buyCurrentMultitapBoost = function(){ buyBoost('multitap',1,1500); };
        window.buyCurrentRechargeBoost = function(){ buyBoost('recharge',1,800); };

        // ====== Tap logic minimal (so tap UI works) ======
        window.tapCoin = (ev) => {
            // visual tap feedback + increment local counters (does not push to firebase automatically)
            const coin = document.getElementById('balance');
            const taps = document.getElementById('totalTaps');
            const tapPowerEl = document.getElementById('tapPower');
            const power = parseInt(tapPowerEl?.textContent||"1",10) || 1;
            let bal = parseInt(coin?.textContent||"0",10) || 0;
            let totalT = parseInt(taps?.textContent||"0",10) || 0;
            bal += power;
            totalT += 1;
            if(coin) coin.textContent = bal;
            if(taps) taps.textContent = totalT;
            // small floating + sign
            const rect = document.getElementById('mainCoin').getBoundingClientRect();
            const fx = document.createElement('div');
            fx.className = 'tap-effect';
            fx.style.left = (rect.left + rect.width/2) + 'px';
            fx.style.top = (rect.top + rect.height/2) + 'px';
            fx.style.position = 'fixed';
            fx.textContent = `+${power}`;
            document.body.appendChild(fx);
            setTimeout(()=> { fx.remove(); }, 900);
        };

        // small UI helpers used by modal buttons
        window.closePlayerModal = function(){ document.getElementById('playerProfileModal').classList.add('hidden'); };
        window.challengePlayer = function(){ alert("Raqobat: demo funksiyasi"); };

        // toggle language demo
        window.toggleLanguage = function(){
            const lt = document.getElementById('languageText');
            if(lt) lt.textContent = lt.textContent === 'UZ' ? 'EN' : 'UZ';
        };

        // initial default: show tap section
        document.addEventListener('DOMContentLoaded', ()=> {
            showSection('tap');
        });

    </script>
</body>
</html>
